# v4.0 数据库迁移错误修复

## 问题描述
执行 `database_update_v4.0.sql` 时报错：
```
ERROR: 23514: new row for relation "tasks" violates check constraint "tasks_status_check"
```

## 原因
数据库的 `tasks_status_check` 约束不允许 `status='paused'`，但迁移脚本尝试将 `'backlog'` 改为 `'paused'`。

## 解决方案

### 方案一：使用修复后的迁移脚本（推荐）

1. 打开 Supabase SQL Editor
2. 复制修复后的 `database_update_v4.0.sql` 全部内容
3. 粘贴并执行

修复后的脚本已经在第零部分添加了约束更新：
```sql
-- 第零部分：更新约束（确保支持 paused 状态）
ALTER TABLE tasks DROP CONSTRAINT IF EXISTS tasks_status_check;
ALTER TABLE tasks ADD CONSTRAINT tasks_status_check 
    CHECK (status IN ('active', 'completed', 'paused', 'backlog'));
```

### 方案二：手动分步执行

如果方案一仍然失败，按以下顺序手动执行：

#### 步骤1：更新约束
```sql
ALTER TABLE tasks DROP CONSTRAINT IF EXISTS tasks_status_check;
ALTER TABLE tasks ADD CONSTRAINT tasks_status_check 
    CHECK (status IN ('active', 'completed', 'paused', 'backlog'));
```

#### 步骤2：添加新字段
```sql
ALTER TABLE tasks 
ADD COLUMN IF NOT EXISTS task_order INTEGER DEFAULT 0 CHECK (task_order >= 0),
ADD COLUMN IF NOT EXISTS display_number VARCHAR(10),
ADD COLUMN IF NOT EXISTS is_deleted BOOLEAN DEFAULT FALSE,
ADD COLUMN IF NOT EXISTS deleted_at TIMESTAMP WITH TIME ZONE,
ADD COLUMN IF NOT EXISTS last_reminded_date DATE;
```

#### 步骤3：创建索引
```sql
CREATE INDEX IF NOT EXISTS idx_tasks_user_quadrant_order 
ON tasks(user_email, quadrant, task_order);

CREATE INDEX IF NOT EXISTS idx_tasks_is_deleted 
ON tasks(is_deleted);

CREATE INDEX IF NOT EXISTS idx_tasks_status_deleted 
ON tasks(status, is_deleted);
```

#### 步骤4：删除已完成任务
```sql
DELETE FROM tasks WHERE status = 'completed';
```

#### 步骤5：统一状态名称
```sql
UPDATE tasks 
SET status = 'paused' 
WHERE status = 'backlog';
```

#### 步骤6：为 Q1 任务分配编号
```sql
WITH numbered_q1 AS (
    SELECT 
        id,
        ROW_NUMBER() OVER (PARTITION BY user_email ORDER BY created_at ASC) as new_order
    FROM tasks
    WHERE quadrant = 1 AND status = 'active' AND is_deleted = FALSE
)
UPDATE tasks t
SET 
    task_order = n.new_order,
    display_number = 'Q1-' || n.new_order
FROM numbered_q1 n
WHERE t.id = n.id;
```

#### 步骤7：为 Q2 任务分配编号
```sql
WITH numbered_q2 AS (
    SELECT 
        id,
        ROW_NUMBER() OVER (PARTITION BY user_email ORDER BY created_at ASC) as new_order
    FROM tasks
    WHERE quadrant = 2 AND status = 'active' AND is_deleted = FALSE
)
UPDATE tasks t
SET 
    task_order = n.new_order,
    display_number = 'Q2-' || n.new_order
FROM numbered_q2 n
WHERE t.id = n.id;
```

#### 步骤8：为 Q3 任务分配编号
```sql
WITH numbered_q3 AS (
    SELECT 
        id,
        ROW_NUMBER() OVER (PARTITION BY user_email ORDER BY created_at ASC) as new_order
    FROM tasks
    WHERE quadrant = 3 AND status = 'active' AND is_deleted = FALSE
)
UPDATE tasks t
SET 
    task_order = n.new_order,
    display_number = 'Q3-' || n.new_order
FROM numbered_q3 n
WHERE t.id = n.id;
```

#### 步骤9：为 Q4 任务分配编号
```sql
WITH numbered_q4 AS (
    SELECT 
        id,
        ROW_NUMBER() OVER (PARTITION BY user_email ORDER BY created_at ASC) as new_order
    FROM tasks
    WHERE quadrant = 4 AND status = 'active' AND is_deleted = FALSE
)
UPDATE tasks t
SET 
    task_order = n.new_order,
    display_number = 'Q4-' || n.new_order
FROM numbered_q4 n
WHERE t.id = n.id;
```

#### 步骤10：为暂缓任务分配编号
```sql
WITH numbered_paused AS (
    SELECT 
        id,
        ROW_NUMBER() OVER (PARTITION BY user_email ORDER BY created_at ASC) as new_order
    FROM tasks
    WHERE status = 'paused' AND is_deleted = FALSE
)
UPDATE tasks t
SET 
    task_order = n.new_order,
    display_number = '暂缓-' || n.new_order
FROM numbered_paused n
WHERE t.id = n.id;
```

#### 步骤11：确保 is_deleted 字段
```sql
UPDATE tasks 
SET is_deleted = FALSE 
WHERE is_deleted IS NULL;
```

## 验证迁移成功

执行以下查询验证：

```sql
-- 检查新字段是否存在
SELECT 
    task_name, 
    task_order, 
    display_number, 
    is_deleted, 
    quadrant, 
    status 
FROM tasks 
WHERE user_email = '你的邮箱@163.com' 
  AND is_deleted = FALSE
ORDER BY quadrant, task_order;
```

应该看到：
- ✅ task_order 有值（1, 2, 3...）
- ✅ display_number 有值（Q1-1, Q1-2...）
- ✅ is_deleted 为 FALSE

## 下一步

迁移成功后，继续执行部署检查清单的第二步：
```bash
python scripts/test_v4_functions.py
```
