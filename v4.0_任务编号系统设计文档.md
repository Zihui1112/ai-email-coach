# v4.0 任务编号系统设计文档

## 📋 概述

v4.0 版本将引入任务编号系统，彻底解决"已完成任务反复出现"的问题，并提供更清晰的任务管理体验。

---

## 🎯 核心目标

1. **解决已完成任务反复出现的问题**
2. **简化用户回复流程**（用编号代替任务名）
3. **自动清理已完成任务**（完成即删除）
4. **独立管理暂缓任务**（每2天提醒一次）
5. **可视化成长进度**（进度条 + 解锁阶梯）

---

## 📊 当前问题分析

### 问题1：任务状态管理混乱
```
现状：
- 任务有3种状态：active, completed, paused
- 已完成任务（completed）仍然存在数据库中
- 每日邮件查询 status=active，但AI可能错误地将completed改回active

根本原因：
- 依赖AI识别任务名称（不准确）
- 没有唯一标识符（任务名可能重复或相似）
- 完成的任务没有真正删除
```

### 问题2：用户回复复杂
```
现状：
- 用户需要完整输入任务名："答辩模拟已完成"
- 任务名可能很长或有歧义
- AI识别任务名不准确

理想状态：
- 用户只需输入编号："Q1任务1完成"
- 简单、明确、不会出错
```

---

## 🏗️ 新架构设计

### 1. 数据库结构调整

#### 1.1 tasks 表新增字段
```sql
ALTER TABLE tasks ADD COLUMN IF NOT EXISTS:
- task_order INTEGER DEFAULT 0  -- 任务在象限内的排序（1, 2, 3...）
- display_number VARCHAR(10)     -- 显示编号（如"Q1-1", "Q2-1"）
- is_deleted BOOLEAN DEFAULT FALSE  -- 软删除标记
- deleted_at TIMESTAMP           -- 删除时间
- last_reminded_date DATE        -- 最后提醒日期（用于暂缓任务）
```

#### 1.2 任务唯一标识
```
组合键：user_email + quadrant + task_order
显示编号：Q{quadrant}-{task_order}
例如：Q1-1, Q1-2, Q2-1, Q2-2
```

#### 1.3 任务状态重新定义
```
- active: 进行中的任务
- paused: 暂缓待办池中的任务
- completed: 已完成（立即软删除，is_deleted=TRUE）
```

---

### 2. 任务显示逻辑

#### 2.1 每日复盘邮件格式
```
📋 今日任务清单：

━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
Q1 🔴 重要且紧急（EXP x2.0）
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
  1. 完成PPT [■■■■■□□□□□] 50%
  2. 完成练习 [□□□□□□□□□□] 0%
  3. 答辩准备 [■■■□□□□□□□] 30%

━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
Q2 🟡 重要非紧急（EXP x1.5）
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
  1. 数据库设计 [■■■■□□□□□□] 40%
  2. 文档整理 [■■□□□□□□□□] 20%

━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
Q3 🔵 紧急非重要（EXP x1.0）
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
  1. 回复邮件 [□□□□□□□□□□] 0%

━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
Q4 ⚪ 非紧急非重要（EXP x0.5）
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
  （暂无任务）

━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
⏸️ 暂缓待办池（每2天提醒一次）
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
  1. 前端优化
  2. 性能测试

💬 回复格式示例：
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
✅ 标记完成：Q1任务1完成
📊 更新进度：Q1任务2进度60%
🆕 新增任务：答辩模拟 Q1
⏸️ 暂缓任务：Q2任务1暂缓
🔄 恢复任务：暂缓任务1恢复到Q1
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
```

#### 2.2 查询逻辑
```sql
-- 活跃任务（按象限和排序显示）
SELECT * FROM tasks 
WHERE user_email = ? 
  AND status = 'active' 
  AND is_deleted = FALSE
ORDER BY quadrant ASC, task_order ASC

-- 暂缓任务（需要提醒的）
SELECT * FROM tasks 
WHERE user_email = ? 
  AND status = 'paused' 
  AND is_deleted = FALSE
  AND (last_reminded_date IS NULL 
       OR last_reminded_date <= CURRENT_DATE - INTERVAL '2 days')
ORDER BY task_order ASC
```

---

### 3. 用户回复解析

#### 3.1 支持的回复格式

**格式1：标记完成**
```
Q1任务1完成
Q1-1完成
Q1任务1 done
```

**格式2：更新进度**
```
Q1任务2进度60%
Q1-2 60%
Q1任务2 80%
```

**格式3：新增任务**
```
新增：答辩准备 Q1
答辩准备 Q1
```

**格式4：暂缓任务**
```
Q2任务1暂缓
Q2-1暂缓
Q2任务1 pause
```

**格式5：恢复暂缓任务**
```
暂缓任务1恢复到Q1
暂缓1恢复Q1
```

#### 3.2 AI解析提示词优化
```python
prompt = f"""请解析用户的任务更新回复，提取任务操作信息。

用户回复：
{user_reply}

解析规则：
1. 任务引用方式：
   - 编号引用：Q1任务1、Q1-1、Q2任务2、Q2-2
   - 暂缓任务引用：暂缓任务1、暂缓1
   - 新增任务：直接写任务名 + 象限

2. 操作类型识别：
   - 完成：包含"完成"、"done"、"finish"、"100%" → action="complete"
   - 暂缓：包含"暂缓"、"pause" → action="pause"
   - 恢复：包含"恢复"、"resume" → action="resume"
   - 更新进度：包含百分比数字 → action="update"
   - 新增：包含"新增"或直接写任务名 → action="create"

3. 返回JSON格式：
{{
  "operation_type": "complete|update|pause|resume|create",
  "quadrant": "Q1|Q2|Q3|Q4",
  "task_number": 1,  // 任务编号（1, 2, 3...）
  "task_name": "任务名称",  // 仅新增任务时需要
  "progress": 60  // 仅更新进度时需要
}}

如果有多个操作，返回JSON数组。
只返回JSON，不要其他内容。
"""
```

---

### 4. 任务操作逻辑

#### 4.1 完成任务
```python
def complete_task(user_email, quadrant, task_number):
    """
    完成任务
    1. 查找任务：user_email + quadrant + task_order
    2. 标记删除：is_deleted=TRUE, deleted_at=NOW()
    3. 重新排序：后面的任务编号前移
    4. 计算奖励：EXP + Coin
    """
    # 查找任务
    task = find_task(user_email, quadrant, task_number)
    
    # 软删除
    task.is_deleted = True
    task.deleted_at = datetime.now()
    task.status = 'completed'
    
    # 计算奖励（100%完成）
    exp_gain = calculate_exp_gain(100 - task.progress, quadrant)
    
    # 重新排序后续任务
    reorder_tasks(user_email, quadrant, task_number)
    
    return {
        'success': True,
        'task_name': task.task_name,
        'exp_gain': exp_gain
    }
```

#### 4.2 更新进度
```python
def update_task_progress(user_email, quadrant, task_number, new_progress):
    """
    更新任务进度
    1. 查找任务
    2. 更新进度
    3. 计算增量EXP
    """
    task = find_task(user_email, quadrant, task_number)
    
    old_progress = task.progress_percentage
    progress_change = new_progress - old_progress
    
    task.progress_percentage = new_progress
    task.updated_at = datetime.now()
    
    # 计算增量EXP
    exp_gain = calculate_exp_gain(progress_change, quadrant)
    
    return {
        'success': True,
        'task_name': task.task_name,
        'old_progress': old_progress,
        'new_progress': new_progress,
        'exp_gain': exp_gain
    }
```

#### 4.3 新增任务
```python
def create_task(user_email, task_name, quadrant):
    """
    新增任务
    1. 查找该象限最大编号
    2. 新编号 = 最大编号 + 1
    3. 创建任务
    """
    # 获取该象限最大编号
    max_order = get_max_task_order(user_email, quadrant)
    new_order = max_order + 1
    
    # 创建任务
    task = Task(
        user_email=user_email,
        task_name=task_name,
        quadrant=quadrant,
        task_order=new_order,
        display_number=f"Q{quadrant}-{new_order}",
        progress_percentage=0,
        status='active',
        is_deleted=False
    )
    
    return {
        'success': True,
        'task_name': task_name,
        'display_number': task.display_number
    }
```

#### 4.4 暂缓任务
```python
def pause_task(user_email, quadrant, task_number):
    """
    暂缓任务
    1. 查找任务
    2. 修改状态为paused
    3. 重新排序该象限的其他任务
    4. 暂缓任务重新编号（从1开始）
    """
    task = find_task(user_email, quadrant, task_number)
    
    # 修改状态
    task.status = 'paused'
    task.last_reminded_date = datetime.now().date()
    
    # 重新排序原象限任务
    reorder_tasks(user_email, quadrant, task_number)
    
    # 暂缓任务重新编号
    reorder_paused_tasks(user_email)
    
    return {
        'success': True,
        'task_name': task.task_name
    }
```

#### 4.5 恢复暂缓任务
```python
def resume_paused_task(user_email, paused_task_number, target_quadrant):
    """
    恢复暂缓任务
    1. 查找暂缓任务
    2. 修改状态为active
    3. 分配新的象限和编号
    4. 重新排序暂缓任务
    """
    task = find_paused_task(user_email, paused_task_number)
    
    # 获取目标象限最大编号
    max_order = get_max_task_order(user_email, target_quadrant)
    new_order = max_order + 1
    
    # 恢复任务
    task.status = 'active'
    task.quadrant = target_quadrant
    task.task_order = new_order
    task.display_number = f"Q{target_quadrant}-{new_order}"
    
    # 重新排序暂缓任务
    reorder_paused_tasks(user_email)
    
    return {
        'success': True,
        'task_name': task.task_name,
        'new_display_number': task.display_number
    }
```

---

### 5. 任务重新排序逻辑

```python
def reorder_tasks(user_email, quadrant, deleted_task_number):
    """
    重新排序任务（删除或暂缓任务后）
    
    例如：
    删除前：Q1-1, Q1-2, Q1-3, Q1-4
    删除Q1-2后：Q1-1, Q1-2(原Q1-3), Q1-3(原Q1-4)
    """
    # 获取该象限所有活跃任务（排除已删除的）
    tasks = get_active_tasks(user_email, quadrant, order_by='task_order')
    
    # 重新编号
    for index, task in enumerate(tasks, start=1):
        task.task_order = index
        task.display_number = f"Q{quadrant}-{index}"
        task.save()
```

```python
def reorder_paused_tasks(user_email):
    """
    重新排序暂缓任务
    """
    paused_tasks = get_paused_tasks(user_email, order_by='task_order')
    
    for index, task in enumerate(paused_tasks, start=1):
        task.task_order = index
        task.display_number = f"暂缓-{index}"
        task.save()
```

---

### 6. 暂缓任务提醒逻辑

#### 6.1 提醒规则
```
- 暂缓任务每2天提醒一次
- 提醒时更新 last_reminded_date
- 只在每日复盘邮件中显示需要提醒的暂缓任务
```

#### 6.2 查询逻辑
```python
def get_paused_tasks_to_remind(user_email):
    """
    获取需要提醒的暂缓任务
    """
    today = datetime.now().date()
    
    # 查询条件：
    # 1. status = 'paused'
    # 2. is_deleted = FALSE
    # 3. last_reminded_date IS NULL（从未提醒）
    #    OR last_reminded_date <= today - 2天
    
    query = f"""
    SELECT * FROM tasks
    WHERE user_email = '{user_email}'
      AND status = 'paused'
      AND is_deleted = FALSE
      AND (last_reminded_date IS NULL 
           OR last_reminded_date <= '{today - timedelta(days=2)}')
    ORDER BY task_order ASC
    """
    
    return execute_query(query)
```

---

### 7. 成长进度可视化

#### 7.1 经验进度条
```
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
📊 你的成长进度：
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
  ⭐ 当前等级：LV3
  
  经验进度：[■■■■■■■□□□] 230/300 (77%)
  
  💰 金币：450 Coin
  🔥 连击：5天
  🎭 性格：🌟 友好型
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
```

#### 7.2 解锁阶梯
```
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
🎯 成长阶梯：
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
  ✅ LV1  四象限报告 + 友好型性格
  ✅ LV3  （当前等级）
  
  🎁 LV4  每日成就盲盒 + 专业型性格
         还需 70 EXP（约2次更新）
  
  📊 LV8  周报数据透视 + 严格型性格
         还需 2070 EXP
  
  🛒 LV13 高级商店 + 毒舌型性格
         还需 7070 EXP
  
  👑 LV20 特殊道具 + 最高等级
         还需 17070 EXP
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━

💪 真棒！再升1级就能解锁 🎁 每日成就盲盒！
```

---

## 🔄 迁移策略

### 方案1：全量迁移（推荐）
```
1. 为所有现有任务分配编号
2. 按象限和创建时间排序
3. 删除所有 status='completed' 的任务
4. 重新编号所有活跃任务
```

### 方案2：渐进迁移
```
1. 新任务使用新系统
2. 旧任务保持原样
3. 用户可以选择迁移或重新创建
```

**建议使用方案1**，一次性迁移，避免两套系统并存。

---

## 📝 实现步骤

### 阶段1：数据库更新
1. 添加新字段
2. 数据迁移脚本
3. 测试迁移

### 阶段2：核心逻辑实现
1. 任务查询逻辑
2. 任务操作逻辑（完成、更新、新增、暂缓、恢复）
3. 任务重新排序逻辑

### 阶段3：显示优化
1. 每日复盘邮件格式
2. 任务更新反馈格式
3. 成长进度可视化

### 阶段4：AI解析优化
1. 编号识别
2. 操作识别
3. 错误处理

### 阶段5：测试和优化
1. 单元测试
2. 集成测试
3. 用户测试

---

## ⚠️ 潜在问题和解决方案

### 问题1：用户忘记任务编号
**解决方案**：
- 每日邮件都显示完整的任务列表和编号
- 支持任务名称模糊匹配（备用方案）

### 问题2：任务编号频繁变化
**解决方案**：
- 只在完成或暂缓任务后重新排序
- 用户看到的编号始终是连续的（1, 2, 3...）

### 问题3：暂缓任务过多
**解决方案**：
- 限制暂缓任务数量（最多10个）
- 超过限制时提示用户清理

### 问题4：AI解析错误
**解决方案**：
- 提供明确的格式示例
- 支持多种表达方式
- 错误时给出友好提示

---

## 📊 预期效果

### 用户体验提升
1. **回复更简单**：Q1任务1完成（vs 答辩模拟已完成）
2. **任务更清晰**：编号一目了然
3. **不再重复**：完成的任务立即消失
4. **暂缓管理**：独立管理，定期提醒

### 系统稳定性提升
1. **唯一标识**：编号 + 象限
2. **准确识别**：不依赖任务名
3. **自动清理**：完成即删除
4. **逻辑清晰**：状态管理明确

---

## 🎯 成功标准

1. ✅ 已完成任务不再出现在每日邮件中
2. ✅ 用户可以用编号快速操作任务
3. ✅ 暂缓任务每2天提醒一次
4. ✅ 成长进度清晰可见
5. ✅ AI识别准确率 > 95%

---

**版本**：v4.0  
**设计日期**：2026-02-11  
**状态**：设计阶段  
**预计实现时间**：2-3小时
