# v3.1 惩罚机制更新总结

## 📊 本次更新概览

v3.1 版本在 v3.0 游戏化系统的基础上，添加了完整的惩罚和奖励机制，让系统更有压力和动力。

---

## ✅ 已完成的功能

### 1. 数据库更新
- ✅ 创建 `punishment_history` 表（惩罚历史记录）
- ✅ 创建 `persistence_rewards` 表（坚持奖励记录）
- ✅ `user_gamification` 表新增 5 个字段：
  - `consecutive_reply_days`（连续回复天数）
  - `last_reply_date`（最后回复日期）
  - `total_reply_days`（累计回复天数）
  - `last_punishment_date`（最后惩罚日期）
  - `total_punishments`（累计惩罚次数）
- ✅ `tasks` 表新增 `last_progress_update` 字段
- ✅ `shop_items` 表新增 4 个惩罚相关道具

### 2. 惩罚机制
- ✅ 连续未回复惩罚（第2天开始）
- ✅ 新手保护期（LV1-3惩罚减半）
- ✅ 降级机制（经验值扣到负数会降级，最低LV1）
- ✅ 金币最低0（可以扣光）
- ✅ 惩罚历史记录

### 3. 奖励机制
- ✅ 连续回复天数追踪
- ✅ 坚持里程碑奖励（3/7/14/30/60/90天）
- ✅ 奖励历史记录
- ✅ 成就称号系统

### 4. 代码实现
- ✅ `gamification_utils.py` 新增 10+ 个惩罚相关函数
- ✅ `daily_review.py` 集成惩罚检测和显示
- ✅ `check_email_reply.py` 集成坚持奖励检测和显示
- ✅ 惩罚消息格式化
- ✅ 奖励消息格式化

### 5. 文档
- ✅ `database_update_v3.1_punishment.sql`（数据库更新脚本）
- ✅ `v3.1惩罚机制部署指南.md`（详细部署步骤）
- ✅ `v3.1更新总结.md`（本文档）

---

## 🔴 惩罚规则

### 连续未回复惩罚
```
第1天：温馨提醒，无惩罚
第2天：-20币 -30经验（LV1-3减半：-10币 -15经验）
第3天：-40币 -60经验（LV1-3减半：-20币 -30经验）
第4天：-60币 -100经验（LV1-3减半：-30币 -50经验）+ 清零Q1连击
第5天+：-80币 -150经验（LV1-3减半：-40币 -75经验）+ 可能降级
```

### 降级规则
- 当前经验值扣到负数时触发降级
- 降级后回到上一级的最大经验值
- 最低等级 LV1（不会降到 LV0）
- 总经验值不减少（只有当前经验值会减少）

### 新手保护
- LV1-3 期间所有惩罚减半
- 惩罚历史中标记 `is_newbie_protected = true`

---

## 🎁 奖励规则

### 坚持里程碑
```
连续3天：+20币 + 🎉 初次坚持
连续7天：+50币 +30经验 + 🏆 坚持一周
连续14天：+100币 +60经验 + 🏆 坚持两周
连续30天：+300币 +150经验 + 🏆 坚持一月 + 特殊称号
连续60天：+600币 +300经验 + 🏆 坚持两月 + 高级称号
连续90天：+1000币 +500经验 + 🏆 坚持三月 + 传说称号
```

### 连续回复追踪
- 每次回复自动更新连续天数
- 中断后重新从1开始计算
- 在反馈邮件中显示：`💡 连续回复：X天 🔥`

---

## 🛒 新增商店道具

### 惩罚相关道具（阶段B待实现）
1. **惩罚减免券**（50 Coin）
   - 免除一次未回复惩罚
   - 限购：每周2张

2. **连击保护卡**（100 Coin）
   - 保护连续回复记录不中断
   - 限购：每月1张

3. **进度锁定符**（80 Coin）
   - 锁定任务进度3天，防止倒退惩罚
   - 限购：每周1张

4. **降级保护盾**（200 Coin）
   - 防止降级一次（自动触发）
   - 限购：每月1张

---

## 📱 用户界面变化

### 每日复盘邮件新增
```
╔═══════════════════════════════════╗
║  ⚠️ 惩罚通知                      ║
╠═══════════════════════════════════╣
║                                   ║
║  连续2天未回复                    ║
║  💰 扣除金币：-20 Coin            ║
║  💫 扣除经验：-30 EXP             ║
║                                   ║
║  💡 提示：定期回复可避免惩罚      ║
║                                   ║
╚═══════════════════════════════════╝
```

### 任务更新反馈新增
```
╔═══════════════════════════════════╗
║  🎉 初次坚持                      ║
╠═══════════════════════════════════╣
║                                   ║
║  🎊 恭喜坚持3天！                 ║
║  💰 奖励金币：+20 Coin            ║
║                                   ║
║  💪 继续保持，更多奖励等着你！    ║
║                                   ║
╚═══════════════════════════════════╝

💡 连续回复：3天 🔥
```

---

## 🚀 部署步骤（简化版）

### 1. 部署数据库（5分钟）
```
1. 登录 Supabase
2. SQL Editor → 粘贴 database_update_v3.1_punishment.sql
3. 点击 Run
4. 验证新表和新字段
```

### 2. 推送代码（2分钟）
```bash
git add .
git commit -m "v3.1: 添加惩罚机制和坚持奖励"
git push origin main
```

### 3. 等待测试（今晚）
```
- 今晚22:00收到每日复盘邮件
- 如果连续2天未回复，会看到惩罚提示
- 回复邮件后会看到连续回复天数
- 连续3天回复会获得坚持奖励
```

---

## ⏳ 待实现功能（阶段B）

以下功能已设计但未实现，等测试通过后再开发：

### 1. 任务拖延检测
- Q1任务超过3天无进度 → 惩罚
- Q2任务超过7天无进度 → 惩罚

### 2. 进度倒退检测
- 任务进度下降 → 惩罚

### 3. 商店道具使用
- 惩罚减免券使用逻辑
- 连击保护卡使用逻辑
- 进度锁定符使用逻辑
- 降级保护盾使用逻辑

### 4. 购买命令识别
- 识别"购买：道具名"命令
- 扣除金币并添加到背包
- 检查购买限制

---

## 📊 技术实现细节

### 新增函数（gamification_utils.py）
1. `calculate_no_reply_punishment()` - 计算未回复惩罚
2. `calculate_task_delay_punishment()` - 计算任务拖延惩罚
3. `calculate_progress_decline_punishment()` - 计算进度倒退惩罚
4. `apply_punishment()` - 执行惩罚（扣除金币和经验值）
5. `log_punishment_history()` - 记录惩罚历史
6. `check_and_apply_no_reply_punishment()` - 检查并执行未回复惩罚
7. `format_punishment_message()` - 格式化惩罚消息
8. `update_consecutive_reply_days()` - 更新连续回复天数
9. `check_persistence_milestone()` - 检查坚持里程碑
10. `format_persistence_reward_message()` - 格式化奖励消息

### 修改的文件
1. `scripts/gamification_utils.py` - 新增惩罚相关函数
2. `scripts/daily_review.py` - 集成惩罚检测
3. `scripts/check_email_reply.py` - 集成坚持奖励

### 数据库变更
1. 新增 2 个表
2. 修改 2 个表（新增字段）
3. 新增 4 个商店道具
4. 新增 8 个索引

---

## 🎯 测试重点

### 必测项目
1. ✅ 连续2天不回复 → 看到惩罚提示
2. ✅ 惩罚后金币和经验值正确扣除
3. ✅ LV1-3惩罚减半
4. ✅ 连续3天回复 → 获得坚持奖励
5. ✅ 连续回复天数正确显示
6. ✅ 降级机制（经验值扣到负数）

### 可选测试
1. 连续7天回复 → 获得更高奖励
2. 中断后重新开始 → 连续天数重置
3. 查看 Supabase 中的历史记录表

---

## 💡 使用建议

### 对用户的建议
1. **每天回复**：避免惩罚，保持连击
2. **坚持3天**：获得第一个奖励
3. **坚持7天**：获得更多奖励和成就
4. **LV1-3期间**：享受新手保护，惩罚减半
5. **升级到LV4+**：惩罚会变重，但奖励也更丰厚

### 对开发者的建议
1. **先测试核心功能**：确保惩罚和奖励正常工作
2. **观察用户反馈**：根据实际使用情况调整惩罚力度
3. **阶段B开发**：等核心功能稳定后再开发商店道具
4. **数据分析**：定期查看 `punishment_history` 和 `persistence_rewards` 表

---

## 📞 问题反馈

如遇到问题：
1. 查看 `v3.1惩罚机制部署指南.md` 中的"问题排查"部分
2. 检查 GitHub Actions 日志
3. 查看 Supabase 中的数据表
4. 复制错误信息并反馈

---

**版本**：v3.1  
**更新日期**：2026-02-10  
**状态**：阶段A（核心惩罚机制）已完成，等待测试  
**下一步**：今晚测试，明天根据测试结果决定是否继续开发阶段B
