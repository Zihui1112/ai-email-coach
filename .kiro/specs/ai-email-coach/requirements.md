# AI邮件督导系统需求文档

## 简介

AI邮件督导系统是一个通过邮件交互的智能任务管理和督导系统。用户可以通过发送邮件来更新任务进度，系统会使用AI分析用户的自然语言输入，自动更新任务状态，并根据用户配置的个性化风格发送反馈邮件。

## 术语表

- **AI邮件督导系统**: 主要的邮件处理和任务管理系统
- **Webhook处理器**: 接收和处理入站邮件的API端点
- **LLM解析器**: 使用大语言模型解析用户自然语言输入的组件
- **数据库同步器**: 负责更新任务状态和数据库记录的组件
- **邮件生成器**: 根据用户偏好生成个性化反馈邮件的组件
- **四象限**: 基于重要性和紧急性的任务分类方法(Q1-Q4)
- **Persona**: 用户配置的AI反馈风格(毒舌/暖心)

## 需求

### 需求1: 邮件接收和解析

**用户故事:** 作为系统管理员，我希望系统能够接收和解析入站邮件，以便提取用户的任务更新信息。

#### 验收标准

1. 当Resend发送webhook请求到`/inbound-email`端点时，系统应当接收并解析JSON数据
2. 当接收到邮件数据时，系统应当提取发件人邮箱地址和邮件正文内容
3. 当邮件格式无效时，系统应当记录错误并返回适当的HTTP状态码
4. 当系统处理邮件时，系统应当验证发件人是否为注册用户
5. 当邮件正文为空时，系统应当拒绝处理并记录警告

### 需求2: 自然语言任务解析

**用户故事:** 作为用户，我希望能用自然语言描述任务进度，系统能够准确理解我的意图，以便自动更新任务状态。

#### 验收标准

1. 当用户发送包含任务信息的邮件时，系统应当使用LLM提取任务名称、进度百分比和象限分类
2. 当用户表达修改计划的意图时，系统应当识别并标记为计划修改请求
3. 当LLM无法解析用户输入时，系统应当请求用户提供更清晰的信息
4. 当用户提及多个任务时，系统应当分别解析每个任务的信息
5. 当解析结果不确定时，系统应当向用户确认解析的准确性

### 需求3: 数据库状态同步

**用户故事:** 作为系统，我需要根据解析的任务信息更新数据库，以便保持任务状态的准确性和一致性。

#### 验收标准

1. 当任务进度达到100%时，系统应当将任务状态更新为'completed'
2. 当识别到新任务时，系统应当在tasks表中插入新记录
3. 当任务信息更新时，系统应当更新对应记录的updated_at时间戳
4. 当数据库操作失败时，系统应当回滚事务并记录错误
5. 当任务不存在时，系统应当创建新任务记录而不是更新现有记录

### 需求4: 个性化邮件反馈生成

**用户故事:** 作为用户，我希望收到个性化的反馈邮件，包含我的任务进度和明日计划，以便保持动力和清晰的目标。

#### 验收标准

1. 当处理完用户邮件时，系统应当根据用户配置的persona生成反馈邮件
2. 当persona设置为"毒舌"时，系统应当对停滞超过24小时的任务使用犀利语气
3. 当persona设置为"暖心"时，系统应当对高压力Q1任务提供温柔的拆解建议
4. 当生成邮件时，系统应当包含ASCII进度条显示任务完成情况
5. 当生成邮件时，系统应当包含"明日四象限清单"和"待办池"部分

### 需求5: 数据持久化和用户配置

**用户故事:** 作为系统，我需要持久化存储任务数据和用户配置，以便提供一致的服务体验。

#### 验收标准

1. 当系统启动时，系统应当连接到Supabase数据库
2. 当存储任务数据时，系统应当使用预定义的tasks表结构
3. 当存储用户配置时，系统应当使用user_configs表保存persona设置
4. 当数据库连接失败时，系统应当记录错误并尝试重连
5. 当执行数据库操作时，系统应当使用事务确保数据一致性

### 需求6: 错误处理和日志记录

**用户故事:** 作为系统管理员，我希望系统能够优雅地处理错误并提供详细的日志，以便监控系统健康状况和调试问题。

#### 验收标准

1. 当发生API错误时，系统应当返回适当的HTTP状态码和错误信息
2. 当LLM调用失败时，系统应当记录错误并使用备用处理逻辑
3. 当邮件发送失败时，系统应当重试并记录失败原因
4. 当系统运行时，系统应当记录关键操作的详细日志
5. 当发生异常时，系统应当捕获异常并记录完整的错误堆栈

### 需求7: 邮件模板和格式化

**用户故事:** 作为用户，我希望收到格式良好、易读的反馈邮件，包含清晰的任务进度可视化。

#### 验收标准

1. 当生成反馈邮件时，系统应当使用ASCII字符创建进度条
2. 当显示任务列表时，系统应当按象限分类组织任务
3. 当格式化邮件时，系统应当使用一致的文本格式和布局
4. 当邮件内容过长时，系统应当适当截断并提供摘要
5. 当包含特殊字符时，系统应当正确编码以确保邮件显示正常

### 需求8: 每日计划交互和复盘

**用户故事:** 作为用户，我希望系统每晚主动询问我明天的计划并让我回顾今天的完成情况，以便更好地管理我的任务和目标。

#### 验收标准

1. 当每晚22:00时，系统应当自动发送复盘邮件询问用户今日任务完成情况
2. 当发送复盘邮件时，系统应当列出当日所有任务的进度状态和完成情况
3. 当用户回复复盘邮件时，系统应当解析用户对任务状态的更新和明日计划
4. 当用户在复盘邮件中提及新的明日任务时，系统应当将其添加到任务列表
5. 当用户确认某些任务需要暂缓时，系统应当将其移入待办池

### 需求9: 复盘反馈和计划确认

**用户故事:** 作为用户，我希望在回复复盘邮件后收到系统的反馈和明日计划确认，以便获得持续的督导和鼓励。

#### 验收标准

1. 当用户回复复盘邮件后，系统应当发送反馈邮件包含对今日表现的点评
2. 当生成反馈邮件时，系统应当根据用户persona提供相应语气的鼓励或督促
3. 当用户提及明日计划时，系统应当在反馈邮件中确认并整理明日任务清单
4. 当用户任务完成率较高时，系统应当给予积极的鼓励和认可
5. 当用户任务完成率较低时，系统应当根据persona提供建设性建议或适度督促

### 需求10: 周期性统计和进步分析

**用户故事:** 作为用户，我希望定期收到我的任务完成统计和进步分析，以便了解自己的表现趋势和改进方向。

#### 验收标准

1. 当每周结束时，系统应当生成周度统计报告包含任务完成率和趋势分析
2. 当每月结束时，系统应当生成月度进步图谱和深度分析报告
3. 当生成统计报告时，系统应当包含任务完成率、象限分布、进步趋势等数据
4. 当分析用户表现时，系统应当识别用户的强项和需要改进的领域
5. 当发送统计邮件时，系统应当根据用户persona调整报告的语气和建议

### 需求11: 定时任务和数据重置

**用户故事:** 作为系统，我需要定期执行维护任务，以便保持数据的准确性和系统的正常运行。

#### 验收标准

1. 当每日凌晨0点时，系统应当自动重置user_configs表中的daily_edit_count为0
2. 当执行定时任务时，系统应当记录执行状态和结果
3. 当定时任务失败时，系统应当记录错误并尝试重新执行
4. 当系统重启时，系统应当恢复未完成的定时任务
5. 当定时任务运行时，系统应当避免与用户操作产生冲突

### 需求12: 计划修改限制和个性化拒绝

**用户故事:** 作为系统，我需要限制用户的计划修改次数，并提供个性化的拒绝反馈。

#### 验收标准

1. 当用户第3次尝试修改计划时，系统应当拒绝修改请求
2. 当发送拒绝邮件时，系统应当根据用户的persona配置生成相应语气的回复
3. 当persona为"毒舌"时，拒绝邮件应当包含对用户变卦行为的嘲讽
4. 当persona为"暖心"时，拒绝邮件应当温和地解释限制原因
5. 当用户尝试超出限制时，系统应当记录该行为用于分析

### 需求13: 任务状态管理和待办池

**用户故事:** 作为用户，我希望能够将任务暂缓到待办池，系统能够智能地重新推荐这些任务。

#### 验收标准

1. 当用户回复"暂缓"、"以后再说"等关键词时，系统应当将任务状态改为backlog
2. 当任务连续3天进度为0%且用户确认入池时，系统应当将任务状态改为backlog
3. 当生成每日计划邮件时，系统应当从backlog中随机选择1-2项任务询问用户
4. 当推荐backlog任务时，系统应当考虑任务的匹配度和优先级
5. 当用户接受backlog任务时，系统应当将其状态改回active

### 需求14: 用户数据隔离和安全

**用户故事:** 作为系统，我需要确保每个用户只能访问和修改自己的数据。

#### 验收标准

1. 当处理任务数据时，系统应当强制绑定user_email字段进行查询
2. 当插入新任务时，系统应当自动设置user_email为当前用户邮箱
3. 当用户查询任务时，系统应当只返回该用户的任务数据
4. 当执行数据库操作时，系统应当在所有查询中包含user_email过滤条件
5. 当用户邮箱验证失败时，系统应当拒绝处理请求

### 需求15: 进度条格式标准化

**用户故事:** 作为用户，我希望在不同邮件客户端中都能看到格式一致的进度条显示。

#### 验收标准

1. 当生成进度条时，系统应当使用等宽字符（■和□）
2. 当显示进度时，系统应当固定进度条长度为10个字符
3. 当格式化进度条时，系统应当使用标准格式：进度：[■■■■□□□□□□] 40%
4. 当进度为0%时，系统应当显示：进度：[□□□□□□□□□□] 0%
5. 当进度为100%时，系统应当显示：进度：[■■■■■■■■■■] 100%

### 需求16: 邮件防抖机制

**用户故事:** 作为用户，我希望系统能够智能处理我的连续邮件，避免收到过多的反馈邮件。

#### 验收标准

1. 当用户在10分钟内发送多封邮件时，系统应当实施防抖机制
2. 当检测到连续邮件时，系统应当以最后一封邮件为准进行处理
3. 当防抖期间收到新邮件时，系统应当取消之前的处理任务
4. 当防抖时间结束时，系统应当处理最新的邮件并发送反馈
5. 当实施防抖时，系统应当记录被忽略的邮件数量用于监控

### 需求17: 版本控制和代码管理

**用户故事:** 作为开发者，我希望使用Git进行代码版本控制和协作开发。

#### 验收标准

1. 当项目初始化时，系统应当创建Git仓库并配置.gitignore文件
2. 当代码变更时，系统应当提供清晰的提交信息和版本标签
3. 当部署代码时，系统应当使用Git标签标记发布版本
4. 当配置文件包含敏感信息时，系统应当使用环境变量而非硬编码
5. 当项目结构变更时，系统应当更新相关文档和配置文件

### 需求18: API安全和验证

**用户故事:** 作为系统管理员，我希望API端点是安全的，只接受来自授权来源的请求。

#### 验收标准

1. 当接收webhook请求时，系统应当验证请求来源是否为Resend
2. 当处理用户邮件时，系统应当验证用户身份和权限
3. 当接收到恶意请求时，系统应当拒绝处理并记录安全事件
4. 当API密钥无效时，系统应当返回401未授权错误
5. 当请求频率过高时，系统应当实施速率限制保护