# v3.1 惩罚机制部署指南

## 📋 更新内容

v3.1 版本添加了完整的惩罚和奖励机制：

### 🔴 惩罚机制
1. **连续未回复惩罚**：第2天开始扣除金币和经验值
2. **任务拖延惩罚**：Q1/Q2任务长时间无进度会被惩罚
3. **进度倒退惩罚**：任务进度下降会被惩罚
4. **降级机制**：经验值扣到负数会降级（最低LV1）
5. **新手保护**：LV1-3期间惩罚减半

### 🎁 奖励机制
1. **坚持奖励**：连续回复3/7/14/30/60/90天获得奖励
2. **连续回复追踪**：显示连续回复天数
3. **成就系统**：达到里程碑获得成就称号

### 🛒 新增商店道具
1. 惩罚减免券（50 Coin）
2. 连击保护卡（100 Coin）
3. 进度锁定符（80 Coin）
4. 降级保护盾（200 Coin）

---

## 🚀 部署步骤

### 第一步：部署数据库更新

1. 登录 Supabase (https://supabase.com)
2. 进入你的项目
3. 点击左侧 **SQL Editor**
4. 打开本地的 `database_update_v3.1_punishment.sql` 文件
5. 复制所有内容（Ctrl+A → Ctrl+C）
6. 粘贴到 SQL 编辑器（Ctrl+V）
7. 点击 **Run** 按钮执行
8. 等待执行完成，看到 ✅ Success 提示

### 验证数据库更新

1. 点击左侧 **Table Editor**
2. 确认看到 2 个新表：
   - [ ] `punishment_history`（惩罚历史）
   - [ ] `persistence_rewards`（坚持奖励）
3. 点击 `user_gamification` 表
4. 确认新增了以下字段：
   - [ ] `consecutive_reply_days`（连续回复天数）
   - [ ] `last_reply_date`（最后回复日期）
   - [ ] `total_reply_days`（累计回复天数）
   - [ ] `last_punishment_date`（最后惩罚日期）
   - [ ] `total_punishments`（累计惩罚次数）
5. 点击 `tasks` 表
6. 确认新增了字段：
   - [ ] `last_progress_update`（最后进度更新日期）
7. 点击 `shop_items` 表
8. 确认新增了4个惩罚相关道具

**✅ 数据库更新完成！**

---

### 第二步：推送代码到 GitHub

```bash
# 查看修改的文件
git status

# 添加所有修改
git add .

# 提交修改
git commit -m "v3.1: 添加惩罚机制和坚持奖励"

# 推送到 GitHub
git push origin main
```

### 验证 GitHub Actions

1. 打开浏览器，访问你的 GitHub 仓库
2. 点击顶部的 **Actions** 标签
3. 查看是否有新的工作流正在运行
4. 等待所有工作流完成（绿色 ✅）

**✅ 代码部署完成！**

---

## 🧪 功能测试

### 测试1：连续未回复惩罚

**测试场景**：故意2天不回复邮件

1. [ ] 第1天：收到每日复盘邮件，不回复
2. [ ] 第2天：收到每日复盘邮件，查看是否有惩罚提示
3. [ ] 预期结果：
   ```
   ╔═══════════════════════════════════╗
   ║  ⚠️ 惩罚通知                      ║
   ╠═══════════════════════════════════╣
   ║                                   ║
   ║  连续2天未回复                    ║
   ║  💰 扣除金币：-20 Coin            ║
   ║  💫 扣除经验：-30 EXP             ║
   ║                                   ║
   ║  💡 提示：定期回复可避免惩罚      ║
   ║                                   ║
   ╚═══════════════════════════════════╝
   ```
4. [ ] 在 Supabase 中查看 `user_gamification` 表，确认金币和经验值已扣除
5. [ ] 在 Supabase 中查看 `punishment_history` 表，确认有惩罚记录

### 测试2：新手保护

**测试场景**：LV1-3期间惩罚减半

1. [ ] 确认当前等级为 LV1-3
2. [ ] 连续2天不回复
3. [ ] 预期结果：扣除 -10 Coin + -15 EXP（减半）
4. [ ] 在 `punishment_history` 表中确认 `is_newbie_protected` 为 true

### 测试3：坚持奖励

**测试场景**：连续回复3天获得奖励

1. [ ] 连续3天回复邮件
2. [ ] 第3天回复后，查看反馈邮件
3. [ ] 预期结果：
   ```
   ╔═══════════════════════════════════╗
   ║  🎉 初次坚持                      ║
   ╠═══════════════════════════════════╣
   ║                                   ║
   ║  🎊 恭喜坚持3天！                 ║
   ║  💰 奖励金币：+20 Coin            ║
   ║                                   ║
   ║  💪 继续保持，更多奖励等着你！    ║
   ║                                   ║
   ╚═══════════════════════════════════╝
   
   💡 连续回复：3天 🔥
   ```
4. [ ] 在 Supabase 中查看 `persistence_rewards` 表，确认有奖励记录

### 测试4：连续回复天数显示

**测试场景**：每次回复都显示连续天数

1. [ ] 回复邮件更新任务
2. [ ] 查看反馈邮件末尾
3. [ ] 预期结果：`💡 连续回复：X天 🔥`
4. [ ] 连续回复多天，确认天数递增

### 测试5：降级机制

**测试场景**：经验值扣到负数导致降级

1. [ ] 先升级到 LV2（需要100 EXP）
2. [ ] 连续5天不回复（扣除150 EXP）
3. [ ] 预期结果：降级到 LV1
4. [ ] 在惩罚消息中看到：`📉 等级下降：LV2 → LV1`

---

## 📊 惩罚规则详细说明

### 连续未回复惩罚

| 天数 | LV4+ 惩罚 | LV1-3 惩罚（减半） | 其他效果 |
|------|-----------|-------------------|----------|
| 1天  | 无惩罚    | 无惩罚            | 温馨提醒 |
| 2天  | -20币 -30经验 | -10币 -15经验 | - |
| 3天  | -40币 -60经验 | -20币 -30经验 | - |
| 4天  | -60币 -100经验 | -30币 -50经验 | 清零Q1连击 |
| 5天+ | -80币 -150经验 | -40币 -75经验 | 清零Q1连击 + 可能降级 |

### 任务拖延惩罚

| 任务类型 | 拖延阈值 | LV4+ 惩罚 | LV1-3 惩罚 |
|---------|---------|-----------|-----------|
| Q1任务  | 3天     | -15币/天  | -8币/天   |
| Q2任务  | 7天     | -10币/天  | -5币/天   |
| Q3/Q4   | 不惩罚  | -         | -         |

### 进度倒退惩罚

| 倒退幅度 | LV4+ 惩罚 | LV1-3 惩罚 |
|---------|-----------|-----------|
| <10%    | 无惩罚    | 无惩罚    |
| 10-20%  | -10币     | -5币      |
| 20-50%  | -20币 -30经验 | -10币 -15经验 |
| >50%    | -40币 -80经验 | -20币 -40经验 |

### 坚持奖励

| 连续天数 | 奖励 | 成就 |
|---------|------|------|
| 3天     | +20币 | 🎉 初次坚持 |
| 7天     | +50币 +30经验 | 🏆 坚持一周 |
| 14天    | +100币 +60经验 | 🏆 坚持两周 |
| 30天    | +300币 +150经验 | 🏆 坚持一月 + 特殊称号 |
| 60天    | +600币 +300经验 | 🏆 坚持两月 + 高级称号 |
| 90天    | +1000币 +500经验 | 🏆 坚持三月 + 传说称号 |

---

## 🐛 问题排查

### 问题1：没有看到惩罚提示
- [ ] 确认数据库已正确更新（新表和新字段都存在）
- [ ] 确认代码已推送到 GitHub
- [ ] 查看 Actions 日志，搜索 "惩罚" 或 "punishment"
- [ ] 在 Supabase 中查看 `user_reply_tracking` 表的 `consecutive_no_reply_days` 字段

### 问题2：惩罚力度不对
- [ ] 确认用户等级（LV1-3是减半的）
- [ ] 查看 `punishment_history` 表中的记录
- [ ] 检查 `is_newbie_protected` 字段是否正确

### 问题3：没有收到坚持奖励
- [ ] 确认连续回复天数达到里程碑（3/7/14/30/60/90）
- [ ] 查看 `user_gamification` 表的 `consecutive_reply_days` 字段
- [ ] 查看 `persistence_rewards` 表，确认没有重复领取

### 问题4：降级不生效
- [ ] 确认当前经验值已经扣到负数
- [ ] 确认等级不是 LV1（LV1不会再降级）
- [ ] 查看 `punishment_history` 表的 `level_before` 和 `level_after` 字段

---

## 📝 数据查看

### 查看惩罚历史
1. 登录 Supabase
2. 点击 **Table Editor**
3. 点击 `punishment_history` 表
4. 查看所有惩罚记录

### 查看坚持奖励
1. 点击 `persistence_rewards` 表
2. 查看所有奖励记录

### 查看用户游戏化数据
1. 点击 `user_gamification` 表
2. 查看新增字段：
   - `consecutive_reply_days`: 连续回复天数
   - `total_reply_days`: 累计回复天数
   - `total_punishments`: 累计惩罚次数

---

## ✅ 部署完成确认

当以下所有项都打勾时，说明 v3.1 部署成功：

- [ ] 数据库 2 个新表创建成功
- [ ] `user_gamification` 表新增 5 个字段
- [ ] `tasks` 表新增 1 个字段
- [ ] `shop_items` 表新增 4 个道具
- [ ] 代码推送到 GitHub 成功
- [ ] GitHub Actions 运行成功
- [ ] 连续2天不回复看到惩罚提示
- [ ] 连续3天回复看到坚持奖励
- [ ] 反馈邮件显示连续回复天数

**🎉 恭喜！v3.1 惩罚机制部署成功！**

---

**最后更新**：2026-02-10  
**版本**：v3.1  
**状态**：阶段A（核心惩罚机制）已完成
