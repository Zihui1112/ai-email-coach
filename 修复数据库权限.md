# 修复Supabase数据库权限问题

## 问题说明

错误信息：
```
new row violates row-level security policy for table "tasks"
```

这是Supabase的行级安全策略（RLS）阻止了数据插入。

## 解决方案

### 步骤1：登录Supabase

1. 访问 https://supabase.com
2. 登录你的账号
3. 选择项目：`cnmxhxapwksjczfxugtx`

### 步骤2：打开SQL编辑器

1. 左侧菜单点击 **SQL Editor**
2. 点击 **New query**

### 步骤3：执行SQL脚本

复制以下SQL并执行：

```sql
-- 禁用RLS（最简单的方案，适合开发测试）
ALTER TABLE tasks DISABLE ROW LEVEL SECURITY;
ALTER TABLE user_configs DISABLE ROW LEVEL SECURITY;
```

或者，如果你想保留RLS但允许所有操作：

```sql
-- 启用RLS但允许所有操作
ALTER TABLE tasks ENABLE ROW LEVEL SECURITY;
ALTER TABLE user_configs ENABLE ROW LEVEL SECURITY;

-- 删除旧策略
DROP POLICY IF EXISTS "允许所有操作" ON tasks;
DROP POLICY IF EXISTS "允许所有操作" ON user_configs;

-- 创建新策略
CREATE POLICY "允许所有操作" ON tasks
    FOR ALL
    USING (true)
    WITH CHECK (true);

CREATE POLICY "允许所有操作" ON user_configs
    FOR ALL
    USING (true)
    WITH CHECK (true);
```

### 步骤4：验证

执行以下查询验证策略：

```sql
SELECT schemaname, tablename, policyname
FROM pg_policies
WHERE tablename IN ('tasks', 'user_configs');
```

### 步骤5：重新测试

回到项目目录，再次运行：

```bash
.\ai-email-coach-env\Scripts\python.exe standalone_coach.py reply "完成了用户登录功能80%，这是Q1任务"
```

应该会看到：
```
✅ 反馈发送成功
```

## 快速方案（推荐）

如果你只是想快速测试，最简单的方法是**完全禁用RLS**：

1. 进入Supabase → SQL Editor
2. 执行：
   ```sql
   ALTER TABLE tasks DISABLE ROW LEVEL SECURITY;
   ALTER TABLE user_configs DISABLE ROW LEVEL SECURITY;
   ```
3. 完成！

## 注意事项

- **开发环境**：可以禁用RLS或使用宽松的策略
- **生产环境**：应该使用严格的RLS策略，基于用户认证

## 验证是否成功

执行SQL查询：

```sql
-- 查看RLS状态
SELECT tablename, rowsecurity
FROM pg_tables
WHERE tablename IN ('tasks', 'user_configs');
```

如果 `rowsecurity` 为 `false`，说明RLS已禁用。

## 完成后

再次测试回复处理功能，应该能正常工作了！
