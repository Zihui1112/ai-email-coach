# v3.0 数据库部署详细指南

## 📋 部署步骤

### 第一步：登录 Supabase

1. 打开浏览器，访问 [https://supabase.com](https://supabase.com)
2. 点击右上角 **Sign In** 登录你的账号
3. 登录后会看到你的项目列表，点击进入你的 **ai-email-coach** 项目

### 第二步：打开 SQL 编辑器

1. 在左侧菜单栏中，找到并点击 **SQL Editor**（SQL 编辑器）图标
   - 图标看起来像一个数据库或者代码符号 `</>`
2. 进入 SQL 编辑器页面后，你会看到一个空白的编辑区域

### 第三步：复制 SQL 脚本

1. 在你的项目文件夹中，打开 `database_update_v3.0.sql` 文件
2. 全选文件内容（Ctrl+A 或 Cmd+A）
3. 复制所有内容（Ctrl+C 或 Cmd+C）

### 第四步：粘贴并执行 SQL

1. 回到 Supabase 的 SQL 编辑器页面
2. 在编辑区域中粘贴刚才复制的 SQL 内容（Ctrl+V 或 Cmd+V）
3. 检查一下内容是否完整（应该能看到创建5个表的语句）
4. 点击右下角的 **Run** 按钮（或按 Ctrl+Enter / Cmd+Enter）

### 第五步：等待执行完成

1. 执行过程中，你会看到一个加载动画
2. 执行成功后，会在下方显示 **Success. No rows returned** 或类似的成功消息
3. 如果出现错误，会显示红色的错误信息（见下方"常见问题"部分）

### 第六步：验证表是否创建成功

1. 在左侧菜单栏中，点击 **Table Editor**（表编辑器）图标
2. 在表列表中，你应该能看到以下5个新表：
   - ✅ `user_gamification`（用户游戏化数据）
   - ✅ `level_config`（等级配置）
   - ✅ `shop_items`（商店道具）
   - ✅ `user_inventory`（用户背包）
   - ✅ `exp_history`（经验值历史）

3. 点击 `level_config` 表，查看是否有20条等级配置数据（LV1-LV20）
4. 点击 `shop_items` 表，查看是否有16条商店道具数据

### 第七步：检查初始数据

1. 点击 `user_gamification` 表
2. 如果表是空的，这是正常的（用户数据会在第一次运行时自动创建）
3. 点击 `level_config` 表，确认有以下数据：
   ```
   Level 1: exp_required=100, unlock_feature=四象限报告
   Level 2: exp_required=200
   Level 3: exp_required=300
   Level 4: exp_required=400, unlock_feature=每日成就盲盒卡片,专业型性格
   ...
   Level 20: exp_required=2000, unlock_feature=特殊道具
   ```

## ✅ 部署完成标志

如果你看到：
- ✅ SQL 执行成功，没有错误
- ✅ 5个新表都出现在表列表中
- ✅ `level_config` 表有20条数据
- ✅ `shop_items` 表有16条数据

**恭喜！数据库部署成功！** 🎉

## ❌ 常见问题和解决方案

### 问题1：表已存在错误
```
ERROR: relation "user_gamification" already exists
```

**原因**：表已经创建过了

**解决方案**：
1. 如果是第一次部署，可以先删除已存在的表
2. 在 SQL 编辑器中执行：
```sql
DROP TABLE IF EXISTS user_gamification CASCADE;
DROP TABLE IF EXISTS level_config CASCADE;
DROP TABLE IF EXISTS shop_items CASCADE;
DROP TABLE IF EXISTS user_inventory CASCADE;
DROP TABLE IF EXISTS exp_history CASCADE;
```
3. 然后重新执行 `database_update_v3.0.sql`

### 问题2：权限错误
```
ERROR: permission denied for table xxx
```

**原因**：使用的 API Key 权限不足

**解决方案**：
1. 确保你使用的是 **service_role** key（在 GitHub Secrets 中配置的）
2. 在 Supabase 中，你作为项目所有者应该有完整权限
3. 如果还是有问题，尝试在 SQL 编辑器右上角切换到 **service_role** 模式

### 问题3：语法错误
```
ERROR: syntax error at or near "xxx"
```

**原因**：SQL 脚本复制不完整或格式错误

**解决方案**：
1. 重新打开 `database_update_v3.0.sql` 文件
2. 确保完整复制所有内容（从第一行到最后一行）
3. 检查是否有特殊字符被错误转换
4. 重新粘贴并执行

### 问题4：找不到 SQL 编辑器
**解决方案**：
1. 确保你已经登录 Supabase
2. 确保你进入了正确的项目
3. SQL 编辑器通常在左侧菜单栏的中间位置
4. 如果找不到，可以尝试刷新页面

## 📸 操作截图参考

### 1. Supabase 项目首页
```
左侧菜单栏：
├── Home
├── Table Editor  ← 用于查看表
├── SQL Editor    ← 用于执行 SQL
├── Database
├── Authentication
└── ...
```

### 2. SQL 编辑器界面
```
┌─────────────────────────────────────────┐
│  SQL Editor                             │
├─────────────────────────────────────────┤
│                                         │
│  [在这里粘贴 SQL 代码]                  │
│                                         │
│                                         │
│                                         │
├─────────────────────────────────────────┤
│                          [Run] 按钮 →   │
└─────────────────────────────────────────┘
```

### 3. 执行成功提示
```
✅ Success. No rows returned
   Execution time: 1.2s
```

## 🔄 如果需要重新部署

如果你想完全重新部署（清空所有游戏化数据）：

1. 先删除所有相关表：
```sql
DROP TABLE IF EXISTS user_gamification CASCADE;
DROP TABLE IF EXISTS level_config CASCADE;
DROP TABLE IF EXISTS shop_items CASCADE;
DROP TABLE IF EXISTS user_inventory CASCADE;
DROP TABLE IF EXISTS exp_history CASCADE;
```

2. 然后重新执行 `database_update_v3.0.sql` 的完整内容

## 📞 需要帮助？

如果遇到其他问题：
1. 复制完整的错误信息
2. 截图 SQL 编辑器的界面
3. 告诉我具体在哪一步遇到问题

我会帮你解决！

---

**提示**：部署数据库后，记得推送代码到 GitHub，让 GitHub Actions 自动部署新的脚本文件。
