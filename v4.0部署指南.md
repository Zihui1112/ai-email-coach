# v4.0 ä»»åŠ¡ç¼–å·ç³»ç»Ÿéƒ¨ç½²æŒ‡å—

## ğŸ“‹ æ¦‚è¿°

v4.0 ç‰ˆæœ¬å¼•å…¥ä»»åŠ¡ç¼–å·ç³»ç»Ÿï¼Œå½»åº•è§£å†³"å·²å®Œæˆä»»åŠ¡åå¤å‡ºç°"çš„é—®é¢˜ï¼Œå¹¶æä¾›æ›´æ¸…æ™°çš„ä»»åŠ¡ç®¡ç†ä½“éªŒã€‚

## âœ… å·²å®Œæˆçš„å·¥ä½œ

### 1. æ•°æ®åº“è¿ç§»è„šæœ¬ âœ“
**æ–‡ä»¶**: `database_update_v4.0.sql`

**åŠŸèƒ½**:
- æ·»åŠ 5ä¸ªæ–°å­—æ®µï¼štask_order, display_number, is_deleted, deleted_at, last_reminded_date
- åˆ›å»º3ä¸ªç´¢å¼•ä¼˜åŒ–æŸ¥è¯¢æ€§èƒ½
- åˆ é™¤æ‰€æœ‰completedä»»åŠ¡
- ä¸ºç°æœ‰ä»»åŠ¡åˆ†é…ç¼–å·ï¼ˆæŒ‰è±¡é™å’Œåˆ›å»ºæ—¶é—´æ’åºï¼‰
- æ•°æ®å®Œæ•´æ€§éªŒè¯

**éƒ¨ç½²æ­¥éª¤**:
1. ç™»å½• Supabase æ§åˆ¶å°
2. è¿›å…¥ SQL Editor
3. å¤åˆ¶ `database_update_v4.0.sql` çš„å…¨éƒ¨å†…å®¹
4. ç²˜è´´å¹¶æ‰§è¡Œ
5. æ£€æŸ¥æ‰§è¡Œç»“æœï¼Œç¡®è®¤æ— é”™è¯¯

### 2. æ ¸å¿ƒå‡½æ•°å®ç° âœ“
**æ–‡ä»¶**: `scripts/gamification_utils.py`

**æ–°å¢å‡½æ•°**:
- `find_task()` - æ ¹æ®è±¡é™å’Œç¼–å·æŸ¥æ‰¾ä»»åŠ¡
- `get_max_task_order()` - è·å–è±¡é™æœ€å¤§ç¼–å·
- `find_paused_task()` - æŸ¥æ‰¾æš‚ç¼“ä»»åŠ¡
- `get_paused_tasks_to_remind()` - è·å–éœ€è¦æé†’çš„æš‚ç¼“ä»»åŠ¡
- `reorder_tasks()` - é‡æ–°æ’åºè±¡é™ä»»åŠ¡
- `reorder_paused_tasks()` - é‡æ–°æ’åºæš‚ç¼“ä»»åŠ¡
- `complete_task()` - å®Œæˆä»»åŠ¡ï¼ˆè½¯åˆ é™¤+é‡æ’åº+å¥–åŠ±ï¼‰
- `update_task_progress()` - æ›´æ–°è¿›åº¦ï¼ˆå¢é‡EXP+è‡ªåŠ¨å®Œæˆï¼‰
- `create_task()` - æ–°å¢ä»»åŠ¡ï¼ˆåˆ†é…ç¼–å·ï¼‰
- `pause_task()` - æš‚ç¼“ä»»åŠ¡ï¼ˆåŒé‡é‡æ’åºï¼‰
- `resume_paused_task()` - æ¢å¤æš‚ç¼“ä»»åŠ¡ï¼ˆé‡æ–°ç¼–å·ï¼‰

**æµ‹è¯•å»ºè®®**:
```python
# æµ‹è¯•æŸ¥æ‰¾ä»»åŠ¡
task = find_task(supabase_url, headers, "user@example.com", 1, 1)
print(task)

# æµ‹è¯•å®Œæˆä»»åŠ¡
result = complete_task(supabase_url, headers, "user@example.com", 1, 1)
print(result)
```

### 3. å¯¼å…¥ä¿®å¤ âœ“
**æ–‡ä»¶**: `scripts/check_email_reply.py`

**ä¿®å¤å†…å®¹**:
- ä¿®å¤äº†å¯¼å…¥è¯­æ³•é”™è¯¯
- æ·»åŠ äº†v4.0ä»»åŠ¡ç¼–å·ç³»ç»Ÿå‡½æ•°çš„å¯¼å…¥

## ğŸš§ å¾…å®Œæˆçš„å·¥ä½œ

### 4. é‡å†™AIè§£æå™¨ï¼ˆcheck_email_reply.pyï¼‰
**çŠ¶æ€**: è¿›è¡Œä¸­

**éœ€è¦ä¿®æ”¹çš„éƒ¨åˆ†**:
1. **AIæç¤ºè¯æ›´æ–°** (çº¦ç¬¬480-520è¡Œ)
   - æ·»åŠ ç¼–å·å¼•ç”¨è§„åˆ™
   - æ”¯æŒ6ç§æ“ä½œç±»å‹ï¼šcomplete, update, create, pause, resume, personality_switch
   - æ”¯æŒä¸¤ç§ç¼–å·æ ¼å¼ï¼šQ1ä»»åŠ¡1 å’Œ Q1-1

2. **è§£æé€»è¾‘é‡å†™** (çº¦ç¬¬540-700è¡Œ)
   - è§£æJSONç»“æœ
   - æ ¹æ®operation_typeè°ƒç”¨å¯¹åº”çš„v4.0å‡½æ•°
   - å¤„ç†ç¼–å·å¼•ç”¨

3. **åé¦ˆé‚®ä»¶ç”Ÿæˆ** (çº¦ç¬¬700-800è¡Œ)
   - ä½¿ç”¨display_numberæ˜¾ç¤ºä»»åŠ¡ç¼–å·
   - æ˜¾ç¤ºæ“ä½œç»“æœ

**å‚è€ƒæç¤ºè¯**:
```python
prompt = f"""è¯·è§£æç”¨æˆ·çš„ä»»åŠ¡æ›´æ–°å›å¤ï¼Œæå–ä»»åŠ¡æ“ä½œä¿¡æ¯ã€‚

ç”¨æˆ·å›å¤ï¼š
{user_reply}

è§£æè§„åˆ™ï¼š
1. ä»»åŠ¡å¼•ç”¨æ–¹å¼ï¼š
   - ç¼–å·å¼•ç”¨ï¼šQ1ä»»åŠ¡1ã€Q1-1ã€Q2ä»»åŠ¡2ã€Q2-2
   - æš‚ç¼“ä»»åŠ¡å¼•ç”¨ï¼šæš‚ç¼“ä»»åŠ¡1ã€æš‚ç¼“1
   - æ–°å¢ä»»åŠ¡ï¼šç›´æ¥å†™ä»»åŠ¡å + è±¡é™

2. æ“ä½œç±»å‹è¯†åˆ«ï¼š
   - å®Œæˆï¼šåŒ…å«"å®Œæˆ"ã€"done"ã€"finish"ã€"100%" â†’ operation_type="complete"
   - æš‚ç¼“ï¼šåŒ…å«"æš‚ç¼“"ã€"pause" â†’ operation_type="pause"
   - æ¢å¤ï¼šåŒ…å«"æ¢å¤"ã€"resume" â†’ operation_type="resume"
   - æ›´æ–°è¿›åº¦ï¼šåŒ…å«ç™¾åˆ†æ¯”æ•°å­— â†’ operation_type="update"
   - æ–°å¢ï¼šåŒ…å«"æ–°å¢"æˆ–ç›´æ¥å†™ä»»åŠ¡å â†’ operation_type="create"

3. è¿”å›JSONæ ¼å¼ï¼š
{{
  "operation_type": "complete|update|pause|resume|create",
  "quadrant": 1,  // è±¡é™æ•°å­— 1-4
  "task_number": 1,  // ä»»åŠ¡ç¼–å·ï¼ˆ1, 2, 3...ï¼‰
  "task_name": "ä»»åŠ¡åç§°",  // ä»…æ–°å¢ä»»åŠ¡æ—¶éœ€è¦
  "progress": 60  // ä»…æ›´æ–°è¿›åº¦æ—¶éœ€è¦
}}

å¦‚æœæœ‰å¤šä¸ªæ“ä½œï¼Œè¿”å›JSONæ•°ç»„ã€‚
åªè¿”å›JSONï¼Œä¸è¦å…¶ä»–å†…å®¹ã€‚
"""
```

**å¤„ç†é€»è¾‘ç¤ºä¾‹**:
```python
# è§£æJSON
operations = json.loads(ai_response)
if not isinstance(operations, list):
    operations = [operations]

# å¤„ç†æ¯ä¸ªæ“ä½œ
for op in operations:
    op_type = op.get('operation_type')
    quadrant = op.get('quadrant')
    task_number = op.get('task_number')
    
    if op_type == 'complete':
        result = complete_task(supabase_url, headers, user_email, quadrant, task_number)
    elif op_type == 'update':
        progress = op.get('progress', 0)
        result = update_task_progress(supabase_url, headers, user_email, quadrant, task_number, progress)
    elif op_type == 'create':
        task_name = op.get('task_name')
        result = create_task(supabase_url, headers, user_email, task_name, quadrant)
    elif op_type == 'pause':
        result = pause_task(supabase_url, headers, user_email, quadrant, task_number)
    elif op_type == 'resume':
        target_quadrant = op.get('quadrant')
        result = resume_paused_task(supabase_url, headers, user_email, task_number, target_quadrant)
    
    # æ”¶é›†ç»“æœç”¨äºåé¦ˆ
    if result.get('success'):
        # ç”Ÿæˆåé¦ˆæ¶ˆæ¯
        pass
```

### 5. é‡å†™æ¯æ—¥å¤ç›˜é‚®ä»¶æ˜¾ç¤ºï¼ˆdaily_review.pyï¼‰
**çŠ¶æ€**: å¾…å¼€å§‹

**éœ€è¦ä¿®æ”¹çš„éƒ¨åˆ†**:
1. **ä»»åŠ¡æŸ¥è¯¢é€»è¾‘** (çº¦ç¬¬157è¡Œ)
```python
# æ—§æŸ¥è¯¢
query_url = f"{supabase_url}/rest/v1/tasks?user_email=eq.{user_email}&status=eq.active&select=*"

# æ–°æŸ¥è¯¢ï¼ˆæ·»åŠ is_deletedè¿‡æ»¤å’Œæ’åºï¼‰
query_url = f"{supabase_url}/rest/v1/tasks?user_email=eq.{user_email}&status=eq.active&is_deleted=eq.false&order=quadrant.asc,task_order.asc&select=*"
```

2. **æŒ‰è±¡é™åˆ†ç»„æ˜¾ç¤º** (çº¦ç¬¬200-300è¡Œ)
```python
# æŒ‰è±¡é™åˆ†ç»„
tasks_by_quadrant = {1: [], 2: [], 3: [], 4: []}
for task in tasks:
    q = task.get('quadrant', 1)
    tasks_by_quadrant[q].append(task)

# æ˜¾ç¤ºæ¯ä¸ªè±¡é™
quadrant_names = {
    1: "Q1 ğŸ”´ é‡è¦ä¸”ç´§æ€¥ï¼ˆEXP x2.0ï¼‰",
    2: "Q2 ğŸŸ¡ é‡è¦éç´§æ€¥ï¼ˆEXP x1.5ï¼‰",
    3: "Q3 ğŸ”µ ç´§æ€¥éé‡è¦ï¼ˆEXP x1.0ï¼‰",
    4: "Q4 âšª éç´§æ€¥éé‡è¦ï¼ˆEXP x0.5ï¼‰"
}

email_content = "ğŸ“‹ ä»Šæ—¥ä»»åŠ¡æ¸…å•ï¼š\n\n"

for q in [1, 2, 3, 4]:
    email_content += "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”\n"
    email_content += f"{quadrant_names[q]}\n"
    email_content += "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”\n"
    
    if tasks_by_quadrant[q]:
        for task in tasks_by_quadrant[q]:
            task_order = task.get('task_order', 0)
            task_name = task.get('task_name', '')
            progress = task.get('progress_percentage', 0)
            
            # ç”Ÿæˆè¿›åº¦æ¡
            filled = int(progress / 10)
            empty = 10 - filled
            progress_bar = "â– " * filled + "â–¡" * empty
            
            email_content += f"  {task_order}. {task_name} [{progress_bar}] {progress}%\n"
    else:
        email_content += "  ï¼ˆæš‚æ— ä»»åŠ¡ï¼‰\n"
    
    email_content += "\n"
```

3. **æš‚ç¼“å¾…åŠæ± æ˜¾ç¤º** (æ–°å¢)
```python
# è·å–éœ€è¦æé†’çš„æš‚ç¼“ä»»åŠ¡
from gamification_utils import get_paused_tasks_to_remind

paused_tasks = get_paused_tasks_to_remind(supabase_url, headers, user_email)

if paused_tasks:
    email_content += "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”\n"
    email_content += "â¸ï¸ æš‚ç¼“å¾…åŠæ± ï¼ˆæ¯2å¤©æé†’ä¸€æ¬¡ï¼‰\n"
    email_content += "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”\n"
    
    for task in paused_tasks:
        task_order = task.get('task_order', 0)
        task_name = task.get('task_name', '')
        email_content += f"  {task_order}. {task_name}\n"
    
    email_content += "\n"
    
    # æ›´æ–°last_reminded_date
    from datetime import datetime
    today = datetime.now().date().isoformat()
    for task in paused_tasks:
        task_id = task['id']
        update_url = f"{supabase_url}/rest/v1/tasks?id=eq.{task_id}"
        requests.patch(update_url, headers=headers, json={"last_reminded_date": today})
```

4. **å›å¤æ ¼å¼ç¤ºä¾‹** (æ–°å¢)
```python
email_content += "ğŸ’¬ å›å¤æ ¼å¼ç¤ºä¾‹ï¼š\n"
email_content += "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”\n"
email_content += "âœ… æ ‡è®°å®Œæˆï¼šQ1ä»»åŠ¡1å®Œæˆ\n"
email_content += "ğŸ“Š æ›´æ–°è¿›åº¦ï¼šQ1ä»»åŠ¡2è¿›åº¦60%\n"
email_content += "ğŸ†• æ–°å¢ä»»åŠ¡ï¼šç­”è¾©æ¨¡æ‹Ÿ Q1\n"
email_content += "â¸ï¸ æš‚ç¼“ä»»åŠ¡ï¼šQ2ä»»åŠ¡1æš‚ç¼“\n"
email_content += "ğŸ”„ æ¢å¤ä»»åŠ¡ï¼šæš‚ç¼“ä»»åŠ¡1æ¢å¤åˆ°Q1\n"
email_content += "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”\n\n"
```

5. **æˆé•¿è¿›åº¦å¯è§†åŒ–** (å·²æœ‰ï¼Œéœ€è¦ç¡®è®¤ä½ç½®)
- æ˜¾ç¤ºå½“å‰ç­‰çº§ã€ç»éªŒå€¼ã€é‡‘å¸
- ç”Ÿæˆç»éªŒè¿›åº¦æ¡
- æ˜¾ç¤ºè¿å‡»å¤©æ•°å’ŒAIæ€§æ ¼
- æ˜¾ç¤ºè§£é”é˜¶æ¢¯

### 6. åˆ›å»ºéƒ¨ç½²æ–‡æ¡£
**çŠ¶æ€**: æœ¬æ–‡æ¡£

## ğŸ“ éƒ¨ç½²æ­¥éª¤æ€»ç»“

### ç¬¬ä¸€æ­¥ï¼šæ•°æ®åº“è¿ç§»ï¼ˆå¿…é¡»ï¼‰
1. ç™»å½• Supabase
2. æ‰§è¡Œ `database_update_v4.0.sql`
3. éªŒè¯è¿ç§»æˆåŠŸ

### ç¬¬äºŒæ­¥ï¼šä»£ç éƒ¨ç½²ï¼ˆå¿…é¡»ï¼‰
1. æäº¤ä»£ç åˆ° GitHub
   ```bash
   git add .
   git commit -m "v4.0: æ·»åŠ ä»»åŠ¡ç¼–å·ç³»ç»Ÿ"
   git push
   ```

2. GitHub Actions ä¼šè‡ªåŠ¨éƒ¨ç½²

### ç¬¬ä¸‰æ­¥ï¼šå®Œæˆå‰©ä½™å¼€å‘ï¼ˆæ¨èï¼‰
1. å®Œæˆ check_email_reply.py çš„AIè§£æå™¨é‡å†™
2. å®Œæˆ daily_review.py çš„é‚®ä»¶æ˜¾ç¤ºé‡å†™
3. æµ‹è¯•å®Œæ•´æµç¨‹

### ç¬¬å››æ­¥ï¼šæµ‹è¯•éªŒè¯
1. æ‰‹åŠ¨è§¦å‘ daily_review workflow
2. æ£€æŸ¥é‚®ä»¶æ ¼å¼æ˜¯å¦æ­£ç¡®
3. å›å¤é‚®ä»¶æµ‹è¯•ç¼–å·è¯†åˆ«
4. éªŒè¯ä»»åŠ¡å®Œæˆåæ˜¯å¦æ¶ˆå¤±

## âš ï¸ æ³¨æ„äº‹é¡¹

1. **æ•°æ®åº“è¿ç§»ä¸å¯é€†**
   - ä¼šåˆ é™¤æ‰€æœ‰completedä»»åŠ¡
   - å»ºè®®å…ˆåœ¨æµ‹è¯•ç¯å¢ƒéªŒè¯

2. **å‘åå…¼å®¹æ€§**
   - æ—§çš„ä»»åŠ¡åç§°è¯†åˆ«ä»ç„¶æœ‰æ•ˆ
   - æ–°ç³»ç»Ÿä¼˜å…ˆä½¿ç”¨ç¼–å·è¯†åˆ«

3. **ç”¨æˆ·å¼•å¯¼**
   - ç¬¬ä¸€æ¬¡ä½¿ç”¨æ—¶ï¼Œé‚®ä»¶ä¼šæ˜¾ç¤ºå›å¤æ ¼å¼ç¤ºä¾‹
   - ç”¨æˆ·å¯ä»¥é€æ­¥é€‚åº”æ–°çš„ç¼–å·ç³»ç»Ÿ

4. **é”™è¯¯å¤„ç†**
   - å¦‚æœç¼–å·ä¸å­˜åœ¨ï¼Œç³»ç»Ÿä¼šè¿”å›å‹å¥½æç¤º
   - æ”¯æŒä»»åŠ¡åç§°ä½œä¸ºå¤‡ç”¨è¯†åˆ«æ–¹å¼

## ğŸ¯ æˆåŠŸæ ‡å‡†

- âœ… å·²å®Œæˆä»»åŠ¡ä¸å†å‡ºç°åœ¨æ¯æ—¥é‚®ä»¶ä¸­
- âœ… ç”¨æˆ·å¯ä»¥ç”¨ç¼–å·å¿«é€Ÿæ“ä½œä»»åŠ¡
- âœ… æš‚ç¼“ä»»åŠ¡æ¯2å¤©æé†’ä¸€æ¬¡
- âœ… æˆé•¿è¿›åº¦æ¸…æ™°å¯è§
- âœ… AIè¯†åˆ«å‡†ç¡®ç‡ > 95%

## ğŸ“ é—®é¢˜æ’æŸ¥

### é—®é¢˜1ï¼šä»»åŠ¡ç¼–å·æ²¡æœ‰æ˜¾ç¤º
**åŸå› **: æ•°æ®åº“è¿ç§»æœªæ‰§è¡Œæˆ–å¤±è´¥
**è§£å†³**: é‡æ–°æ‰§è¡Œ `database_update_v4.0.sql`

### é—®é¢˜2ï¼šAIæ— æ³•è¯†åˆ«ç¼–å·
**åŸå› **: check_email_reply.py æœªæ›´æ–°
**è§£å†³**: å®ŒæˆAIè§£æå™¨é‡å†™

### é—®é¢˜3ï¼šå®Œæˆçš„ä»»åŠ¡ä»ç„¶å‡ºç°
**åŸå› **: è½¯åˆ é™¤é€»è¾‘æœªç”Ÿæ•ˆ
**è§£å†³**: æ£€æŸ¥ complete_task() å‡½æ•°æ˜¯å¦æ­£ç¡®è°ƒç”¨

### é—®é¢˜4ï¼šç¼–å·ä¸è¿ç»­
**åŸå› **: é‡æ’åºé€»è¾‘æœªæ‰§è¡Œ
**è§£å†³**: æ£€æŸ¥ reorder_tasks() å‡½æ•°

## ğŸ“š ç›¸å…³æ–‡æ¡£

- éœ€æ±‚æ–‡æ¡£: `.kiro/specs/task-numbering-system/requirements.md`
- è®¾è®¡æ–‡æ¡£: `.kiro/specs/task-numbering-system/design.md`
- ä»»åŠ¡åˆ—è¡¨: `.kiro/specs/task-numbering-system/tasks.md`
- åŸå§‹è®¾è®¡: `v4.0_ä»»åŠ¡ç¼–å·ç³»ç»Ÿè®¾è®¡æ–‡æ¡£.md`

---

**ç‰ˆæœ¬**: v4.0
**åˆ›å»ºæ—¥æœŸ**: 2026-02-25
**çŠ¶æ€**: éƒ¨åˆ†å®Œæˆï¼ˆæ ¸å¿ƒå‡½æ•°å·²å®ç°ï¼Œå¾…é›†æˆåˆ°é‚®ä»¶å¤„ç†æµç¨‹ï¼‰
