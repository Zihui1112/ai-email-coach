# v4.0 check_email_reply.py é›†æˆæŒ‡å—

## æ¦‚è¿°

æœ¬æ–‡æ¡£è¯´æ˜å¦‚ä½•å°†v4.0ä»»åŠ¡ç¼–å·ç³»ç»Ÿé›†æˆåˆ° `scripts/check_email_reply.py` ä¸­ã€‚

## å·²å®Œæˆçš„å‡†å¤‡å·¥ä½œ

1. âœ… ä¿®å¤äº†å¯¼å…¥é”™è¯¯
2. âœ… æ·»åŠ äº†v4.0å‡½æ•°çš„å¯¼å…¥
3. âœ… åˆ›å»ºäº†3ä¸ªè¾…åŠ©å‡½æ•°ï¼š
   - `parse_task_operations_v4()` - AIè§£æç”¨æˆ·å›å¤
   - `process_task_operations_v4()` - å¤„ç†ä»»åŠ¡æ“ä½œ
   - `format_operation_feedback_v4()` - æ ¼å¼åŒ–åé¦ˆæ¶ˆæ¯

## éœ€è¦ä¿®æ”¹çš„ä½ç½®

### ä½ç½®1ï¼šæ·»åŠ å¯¼å…¥ï¼ˆå·²å®Œæˆï¼‰

åœ¨æ–‡ä»¶å¼€å¤´çš„å¯¼å…¥éƒ¨åˆ†ï¼Œå·²æ·»åŠ ï¼š
```python
from gamification_utils import (
    # ... å…¶ä»–å¯¼å…¥ ...
    # v4.0 ä»»åŠ¡ç¼–å·ç³»ç»Ÿå‡½æ•°
    find_task,
    complete_task,
    update_task_progress,
    create_task,
    pause_task,
    resume_paused_task,
    parse_task_operations_v4,
    process_task_operations_v4,
    format_operation_feedback_v4
)
```

### ä½ç½®2ï¼šæ›¿æ¢AIè§£æé€»è¾‘ï¼ˆçº¦ç¬¬476-560è¡Œï¼‰

**åŸä»£ç **:
```python
# ä½¿ç”¨ DeepSeek AI è§£æå›å¤
print("\nä½¿ç”¨ AI è§£æå›å¤...")

headers = {
    "Authorization": f"Bearer {deepseek_api_key}",
    "Content-Type": "application/json"
}

prompt = f"""è¯·è§£æä»¥ä¸‹ä»»åŠ¡æ›´æ–°å†…å®¹ï¼Œæå–ä»»åŠ¡ä¿¡æ¯ã€‚
...ï¼ˆæ—§çš„æç¤ºè¯ï¼‰
"""

# ... AIè°ƒç”¨å’ŒJSONè§£æ ...
```

**æ–°ä»£ç **:
```python
# v4.0ï¼šä½¿ç”¨æ–°çš„AIè§£æå™¨ï¼ˆæ”¯æŒä»»åŠ¡ç¼–å·ï¼‰
print("\nä½¿ç”¨ AI è§£æå›å¤ï¼ˆv4.0ï¼‰...")

operations = parse_task_operations_v4(latest_reply, deepseek_api_key)

if not operations:
    print("âŒ AIè§£æå¤±è´¥")
    return False

print(f"âœ… è§£æåˆ° {len(operations)} ä¸ªæ“ä½œ")
```

### ä½ç½®3ï¼šæ›¿æ¢ä»»åŠ¡å¤„ç†é€»è¾‘ï¼ˆçº¦ç¬¬560-700è¡Œï¼‰

**åŸä»£ç **:
```python
# æ›´æ–°æ•°æ®åº“
print("\næ›´æ–°æ•°æ®åº“...")

feedback_content = "ğŸ“Š ä»»åŠ¡æ›´æ–°åé¦ˆ\n\n"

# ç”¨äºç´¯è®¡ç»éªŒå€¼å’Œé‡‘å¸
total_exp_gain = 0
total_coins_gain = 0
completed_tasks = 0
total_tasks = len(tasks_data)
has_q1_task = False
q1_all_completed = True

for task_data in tasks_data:
    task_name = task_data.get('task_name', '')
    progress = task_data.get('progress', 0)
    quadrant = task_data.get('quadrant', 'Q1')
    action = task_data.get('action', 'update')
    
    # ... å¤§é‡çš„ä»»åŠ¡å¤„ç†é€»è¾‘ ...
```

**æ–°ä»£ç **:
```python
# v4.0ï¼šå¤„ç†ä»»åŠ¡æ“ä½œ
print("\nå¤„ç†ä»»åŠ¡æ“ä½œï¼ˆv4.0ï¼‰...")

operation_results = process_task_operations_v4(
    supabase_url, 
    db_headers, 
    email_username, 
    operations
)

# ç”Ÿæˆåé¦ˆæ¶ˆæ¯
feedback_content = format_operation_feedback_v4(operation_results)

# è·å–æ€»ç»éªŒå€¼å’Œé‡‘å¸
total_exp_gain = operation_results.get('total_exp_gain', 0)
total_coins_gain = operation_results.get('total_coins_gain', 0)

print(f"âœ… å¤„ç†å®Œæˆï¼šEXP +{total_exp_gain}, Coins +{total_coins_gain}")
```

### ä½ç½®4ï¼šä¿ç•™ç°æœ‰çš„æ¸¸æˆåŒ–é€»è¾‘ï¼ˆçº¦ç¬¬700-800è¡Œï¼‰

ä»¥ä¸‹é€»è¾‘ä¿æŒä¸å˜ï¼š
- æ›´æ–°ç”¨æˆ·ç»éªŒå€¼å’Œé‡‘å¸
- æ£€æŸ¥Q1è¿å‡»
- æ£€æŸ¥å‡çº§
- æ›´æ–°è¿ç»­å›å¤å¤©æ•°
- æ£€æŸ¥åšæŒé‡Œç¨‹ç¢‘
- æ€§æ ¼åˆ‡æ¢å¤„ç†
- è´­ä¹°é“å…·å¤„ç†
- ç”Ÿæˆä¸ªæ€§åŒ–åé¦ˆ

åªéœ€è¦ç¡®ä¿è¿™äº›é€»è¾‘ä½¿ç”¨æ­£ç¡®çš„å˜é‡åã€‚

## å®Œæ•´çš„ä¿®æ”¹ç¤ºä¾‹

### ä¿®æ”¹å‰ï¼ˆæ—§ç‰ˆæœ¬ï¼‰

```python
# ä½¿ç”¨ DeepSeek AI è§£æå›å¤
print("\nä½¿ç”¨ AI è§£æå›å¤...")

headers = {
    "Authorization": f"Bearer {deepseek_api_key}",
    "Content-Type": "application/json"
}

prompt = f"""è¯·è§£æä»¥ä¸‹ä»»åŠ¡æ›´æ–°å†…å®¹ï¼Œæå–ä»»åŠ¡ä¿¡æ¯ã€‚

ç”¨æˆ·å›å¤ï¼š
{latest_reply}

è¯·ä»¥JSONæ ¼å¼è¿”å›ï¼ŒåŒ…å«ä»¥ä¸‹å­—æ®µï¼š
- task_name: ä»»åŠ¡åç§°
- progress: è¿›åº¦ç™¾åˆ†æ¯”(0-100)
- quadrant: è±¡é™(Q1/Q2/Q3/Q4)
- action: åŠ¨ä½œ(update/pause/complete)
...
"""

data = {
    "model": "deepseek-chat",
    "messages": [
        {"role": "user", "content": prompt}
    ],
    "temperature": 0.7
}

response = requests.post(
    "https://api.deepseek.com/v1/chat/completions",
    headers=headers,
    json=data,
    timeout=30
)

if response.status_code != 200:
    print(f"âŒ AI è§£æå¤±è´¥: {response.status_code}")
    return False

result = response.json()
ai_response = result['choices'][0]['message']['content'].strip()

# æ¸…ç† markdown ä»£ç å—
ai_response = re.sub(r'```json\s*', '', ai_response)
ai_response = re.sub(r'```\s*', '', ai_response)
ai_response = ai_response.strip()

print(f"AI è§£æç»“æœ: {ai_response}")

# è§£æ JSON
try:
    tasks_data = json.loads(ai_response)
    if not isinstance(tasks_data, list):
        tasks_data = [tasks_data]
except:
    print("âŒ æ— æ³•è§£æ AI è¿”å›çš„ JSON")
    return False

# æ›´æ–°æ•°æ®åº“
print("\næ›´æ–°æ•°æ®åº“...")

feedback_content = "ğŸ“Š ä»»åŠ¡æ›´æ–°åé¦ˆ\n\n"

# ç”¨äºç´¯è®¡ç»éªŒå€¼å’Œé‡‘å¸
total_exp_gain = 0
total_coins_gain = 0
completed_tasks = 0
total_tasks = len(tasks_data)
has_q1_task = False
q1_all_completed = True

for task_data in tasks_data:
    task_name = task_data.get('task_name', '')
    progress = task_data.get('progress', 0)
    quadrant = task_data.get('quadrant', 'Q1')
    action = task_data.get('action', 'update')
    
    # ... å¤§é‡çš„ä»»åŠ¡å¤„ç†é€»è¾‘ï¼ˆçº¦150è¡Œï¼‰...
```

### ä¿®æ”¹åï¼ˆv4.0ç‰ˆæœ¬ï¼‰

```python
# v4.0ï¼šä½¿ç”¨æ–°çš„AIè§£æå™¨ï¼ˆæ”¯æŒä»»åŠ¡ç¼–å·ï¼‰
print("\nä½¿ç”¨ AI è§£æå›å¤ï¼ˆv4.0ï¼‰...")

operations = parse_task_operations_v4(latest_reply, deepseek_api_key)

if not operations:
    print("âŒ AIè§£æå¤±è´¥")
    return False

print(f"âœ… è§£æåˆ° {len(operations)} ä¸ªæ“ä½œ")

# v4.0ï¼šå¤„ç†ä»»åŠ¡æ“ä½œ
print("\nå¤„ç†ä»»åŠ¡æ“ä½œï¼ˆv4.0ï¼‰...")

operation_results = process_task_operations_v4(
    supabase_url, 
    db_headers, 
    email_username, 
    operations
)

# ç”Ÿæˆåé¦ˆæ¶ˆæ¯
feedback_content = format_operation_feedback_v4(operation_results)

# è·å–æ€»ç»éªŒå€¼å’Œé‡‘å¸
total_exp_gain = operation_results.get('total_exp_gain', 0)
total_coins_gain = operation_results.get('total_coins_gain', 0)

print(f"âœ… å¤„ç†å®Œæˆï¼šEXP +{total_exp_gain}, Coins +{total_coins_gain}")

# æ³¨æ„ï¼šQ1è¿å‡»æ£€æŸ¥éœ€è¦å•ç‹¬å¤„ç†
# å› ä¸ºv4.0ä½¿ç”¨ç¼–å·ç³»ç»Ÿï¼Œéœ€è¦æŸ¥è¯¢Q1è±¡é™çš„ä»»åŠ¡çŠ¶æ€
has_q1_task = False
q1_all_completed = True

# æŸ¥è¯¢Q1ä»»åŠ¡
q1_query_url = f"{supabase_url}/rest/v1/tasks?user_email=eq.{email_username}&quadrant=eq.1&status=eq.active&is_deleted=eq.false&select=*"
q1_response = requests.get(q1_query_url, headers=db_headers, timeout=30)

if q1_response.status_code == 200:
    q1_tasks = q1_response.json()
    if q1_tasks:
        has_q1_task = True
        # æ£€æŸ¥æ˜¯å¦æ‰€æœ‰Q1ä»»åŠ¡éƒ½å®Œæˆäº†
        for task in q1_tasks:
            if task.get('progress_percentage', 0) < 100:
                q1_all_completed = False
                break
```

## éœ€è¦åˆ é™¤çš„ä»£ç 

ä»¥ä¸‹ä»£ç å¯ä»¥åˆ é™¤ï¼ˆå› ä¸ºå·²è¢«v4.0å‡½æ•°æ›¿ä»£ï¼‰ï¼š

1. æ—§çš„AIæç¤ºè¯ï¼ˆçº¦ç¬¬490-520è¡Œï¼‰
2. æ—§çš„JSONè§£æé€»è¾‘ï¼ˆçº¦ç¬¬530-560è¡Œï¼‰
3. æ—§çš„ä»»åŠ¡å¤„ç†å¾ªç¯ï¼ˆçº¦ç¬¬560-700è¡Œï¼‰
   - åŒ…æ‹¬ï¼šæŸ¥è¯¢ä»»åŠ¡ã€æ›´æ–°ä»»åŠ¡ã€åˆ›å»ºä»»åŠ¡çš„é€»è¾‘
   - ä½†ä¿ç•™ï¼šç»éªŒå€¼ç´¯è®¡ã€Q1è¿å‡»æ£€æŸ¥çš„å˜é‡

## æµ‹è¯•å»ºè®®

ä¿®æ”¹å®Œæˆåï¼Œå»ºè®®è¿›è¡Œä»¥ä¸‹æµ‹è¯•ï¼š

1. **æµ‹è¯•ç¼–å·è¯†åˆ«**
   - å›å¤ï¼š"Q1ä»»åŠ¡1å®Œæˆ"
   - é¢„æœŸï¼šä»»åŠ¡è¢«æ ‡è®°å®Œæˆå¹¶è½¯åˆ é™¤

2. **æµ‹è¯•è¿›åº¦æ›´æ–°**
   - å›å¤ï¼š"Q1ä»»åŠ¡2è¿›åº¦60%"
   - é¢„æœŸï¼šä»»åŠ¡è¿›åº¦æ›´æ–°ä¸º60%

3. **æµ‹è¯•æ–°å¢ä»»åŠ¡**
   - å›å¤ï¼š"ç­”è¾©å‡†å¤‡ Q1"
   - é¢„æœŸï¼šåœ¨Q1è±¡é™åˆ›å»ºæ–°ä»»åŠ¡

4. **æµ‹è¯•æš‚ç¼“ä»»åŠ¡**
   - å›å¤ï¼š"Q2ä»»åŠ¡1æš‚ç¼“"
   - é¢„æœŸï¼šä»»åŠ¡ç§»å…¥æš‚ç¼“æ± 

5. **æµ‹è¯•æ¢å¤ä»»åŠ¡**
   - å›å¤ï¼š"æš‚ç¼“ä»»åŠ¡1æ¢å¤åˆ°Q1"
   - é¢„æœŸï¼šä»»åŠ¡ä»æš‚ç¼“æ± æ¢å¤åˆ°Q1

## æ³¨æ„äº‹é¡¹

1. **å‘åå…¼å®¹**ï¼šå¦‚æœAIæ— æ³•è¯†åˆ«ç¼–å·ï¼Œå¯ä»¥æ·»åŠ å›é€€é€»è¾‘ä½¿ç”¨ä»»åŠ¡åç§°
2. **é”™è¯¯å¤„ç†**ï¼šç¡®ä¿æ‰€æœ‰æ“ä½œéƒ½æœ‰é€‚å½“çš„é”™è¯¯å¤„ç†
3. **æ—¥å¿—è®°å½•**ï¼šä¿ç•™è¯¦ç»†çš„æ—¥å¿—è¾“å‡ºï¼Œä¾¿äºè°ƒè¯•
4. **æ€§èƒ½ä¼˜åŒ–**ï¼šæ‰¹é‡æ“ä½œå¯ä»¥å‡å°‘æ•°æ®åº“è¯·æ±‚æ¬¡æ•°

## å®Œæˆæ ‡å‡†

- âœ… AIèƒ½å¤Ÿæ­£ç¡®è¯†åˆ«ä»»åŠ¡ç¼–å·
- âœ… å®Œæˆçš„ä»»åŠ¡ä¸å†å‡ºç°åœ¨ä¸‹æ¬¡é‚®ä»¶ä¸­
- âœ… ä»»åŠ¡ç¼–å·ä¿æŒè¿ç»­
- âœ… æš‚ç¼“ä»»åŠ¡æ­£ç¡®ç®¡ç†
- âœ… ç»éªŒå€¼å’Œé‡‘å¸æ­£ç¡®è®¡ç®—
- âœ… åé¦ˆæ¶ˆæ¯æ¸…æ™°æ˜“æ‡‚

---

**ç‰ˆæœ¬**: v4.0
**åˆ›å»ºæ—¥æœŸ**: 2026-02-25
**çŠ¶æ€**: å¾…é›†æˆ
