# AI Email Coach v2.0 更新说明

## 🎉 新功能

### 1. 暂缓任务管理 ⏸️

#### 问题
- 之前暂缓的任务会从任务清单中消失，无法追踪

#### 解决方案
- ✅ 暂缓任务保存在数据库中（status='paused'）
- ✅ 每周日21:00自动发送暂缓任务检查提醒
- ✅ 显示每个暂缓任务已暂缓的天数
- ✅ 询问哪些任务需要重新开始

#### 使用方法
1. 在回复邮件时说"暂缓XX任务"
2. 任务状态会变为 paused
3. 每周日会收到暂缓任务检查邮件
4. 回复邮件说明哪些任务要重新开始

### 2. AI个性化反馈 🤖

#### 问题
- 之前的反馈太机械，总是"继续加油"
- 没有根据实际情况给出不同的反馈

#### 解决方案
- ✅ 使用 DeepSeek AI 生成个性化反馈
- ✅ 根据任务进度变化给出不同反馈
  - 进度提升大 → 表扬鼓励
  - 进度变化小 → 温和提醒
  - 任务暂缓 → 表示理解
- ✅ 根据任务数量给出建议
  - 任务多 → 提醒合理安排
  - 任务少 → 鼓励增加挑战
- ✅ 语气温暖友好，像朋友一样

#### 示例反馈
**进度提升大时**：
> 哇，用户登录功能从60%提升到90%，进展真快！看来你最近状态不错。数据库设计刚开始，不着急，一步步来就好。

**任务多时**：
> 看到你手上有5个任务在进行，要注意合理分配时间哦。建议优先完成Q1象限的任务，这样会更有成就感。

**暂缓任务时**：
> 理解你暂缓了API开发，有时候确实需要调整优先级。专注在当前的任务上，等时机合适再继续也不迟。

### 3. 连续未回复提醒 ⚠️

#### 问题
- 用户某天没回复，第二天没有任何反应
- 连续多天不回复也没有强烈提醒

#### 解决方案
- ✅ 追踪用户最后回复时间
- ✅ 计算连续未回复天数
- ✅ 根据天数调整提醒强度

#### 提醒等级

**0天（正常）**：
> 🌙 周一晚上好！又到了复盘时间~

**1天未回复**：
> 👋 周二晚上好！昨天好像没看到你的回复，今天一起来复盘吧~

**2天未回复**：
> 🤔 周三晚上好！已经两天没见到你了，是不是最近比较忙？抽空复盘一下吧！

**3天以上未回复**：
> ⚠️ 周四晚上好！已经3天没有回复了！别让任务积压太久哦，今天一定要回复！
> 
> ⚠️ 重要提醒：
> 已经3天没有更新任务了！
> 长时间不复盘可能会让任务失控，今天一定要回复哦！

## 🗄️ 数据库更新

### 新增表

#### 1. user_reply_tracking（用户回复追踪表）
```sql
CREATE TABLE user_reply_tracking (
    id UUID PRIMARY KEY,
    user_email VARCHAR(255) UNIQUE,
    last_reply_date DATE,
    consecutive_no_reply_days INTEGER DEFAULT 0,
    total_replies INTEGER DEFAULT 0,
    created_at TIMESTAMP,
    updated_at TIMESTAMP
);
```

#### 2. task_progress_snapshot（任务进度快照表）
```sql
CREATE TABLE task_progress_snapshot (
    id UUID PRIMARY KEY,
    user_email VARCHAR(255),
    task_name VARCHAR(500),
    progress_percentage INTEGER,
    status VARCHAR(20),
    snapshot_date DATE,
    created_at TIMESTAMP,
    UNIQUE(user_email, task_name, snapshot_date)
);
```

### 修改表

#### tasks 表 - 添加 'paused' 状态
```sql
ALTER TABLE tasks DROP CONSTRAINT IF EXISTS tasks_status_check;
ALTER TABLE tasks ADD CONSTRAINT tasks_status_check 
    CHECK (status IN ('active', 'completed', 'paused', 'backlog'));
```

## 📅 新的时间安排

| 时间 | 任务 | 说明 |
|------|------|------|
| 每天 22:00 | 每日复盘提醒 | 包含连续未回复提醒 |
| 每天 23:00 | 每日跟进提醒 | 提醒尽快回复 |
| 每天 23:30 | 检查邮件回复 | AI个性化反馈 |
| 每周日 21:00 | 暂缓任务检查 | 询问是否重新开始 |
| 每周一 09:00 | 周报 | 自动生成 |
| 每月1号 09:00 | 月报 | 自动生成 |

## 🚀 部署步骤

### 1. 更新数据库

在 Supabase 中执行 `database_update_v2.sql`：

```bash
# 登录 Supabase 控制台
# 进入 SQL Editor
# 粘贴并执行 database_update_v2.sql
```

### 2. 推送代码到 GitHub

```bash
git add -A
git commit -m "v2.0: 添加暂缓任务管理、AI个性化反馈、连续未回复提醒"
git push
```

### 3. 验证部署

访问 GitHub Actions 查看新的 workflow：
- https://github.com/Zihui1112/ai-email-coach/actions

手动触发测试：
1. 每日复盘提醒 - 测试连续未回复提醒
2. 检查邮件回复 - 测试AI个性化反馈
3. 每周暂缓任务检查 - 测试暂缓任务提醒

## 📝 使用示例

### 暂缓任务

**回复邮件**：
```
完成了用户登录功能90%，这是Q1任务
暂缓API开发，这是Q2任务
```

**系统反应**：
- API开发任务状态变为 paused
- 不再出现在每日任务清单中
- 每周日会询问是否重新开始

### 重新开始暂缓任务

**周日收到提醒后回复**：
```
重新开始API开发
继续暂缓数据库优化
```

**系统反应**：
- API开发状态变为 active
- 重新出现在每日任务清单中
- 数据库优化继续保持 paused

### AI个性化反馈

**你的回复**：
```
完成了用户登录功能从60%到90%
数据库设计开始了，现在10%
```

**AI反馈示例**：
> 哇，用户登录功能进展神速，从60%一下子到90%了！看来你最近状态很好，保持这个节奏。数据库设计刚起步，慢慢来，打好基础最重要。两个任务都在Q1象限，说明你很清楚优先级，这点做得很棒！

## ⚠️ 注意事项

### 数据库更新
- 必须先执行 `database_update_v2.sql` 才能使用新功能
- 如果不更新数据库，系统会报错

### AI反馈
- 需要 DeepSeek API key
- 如果 API 调用失败，会使用默认反馈
- AI 反馈可能需要几秒钟生成

### 暂缓任务
- 暂缓任务不会出现在每日任务清单中
- 只在每周日的提醒中出现
- 如果没有暂缓任务，不会发送周日提醒

## 🎯 效果对比

### 之前 vs 现在

#### 反馈对比

**之前**：
> 📊 任务更新反馈
> 
> ✅ 用户登录功能
>    进度：[■■■■■■■■■□] 90%
>    象限: Q1
> 
> 💪 继续加油！

**现在**：
> 📊 任务更新反馈
> 
> ✅ 用户登录功能
>    进度：[■■■■■■■■■□] 90%
>    象限: Q1
> 
> 哇，用户登录功能从60%提升到90%，进展真快！看来你最近状态不错。保持这个节奏，相信很快就能完成了。

#### 未回复提醒对比

**之前**：
> 🌙 晚上好！今天的任务完成情况如何？

**现在（3天未回复）**：
> ⚠️ 周四晚上好！已经3天没有回复了！别让任务积压太久哦，今天一定要回复！
> 
> ⚠️ 重要提醒：
> 已经3天没有更新任务了！
> 长时间不复盘可能会让任务失控，今天一定要回复哦！

## 🐛 已知问题

1. **AI反馈偶尔会重复** - 正在优化提示词
2. **暂缓任务天数计算可能不准** - 基于 updated_at 字段
3. **连续未回复天数在首次部署时为0** - 需要运行一天后才准确

## 📞 反馈和建议

如果你有任何问题或建议，请：
1. 查看 GitHub Actions 日志
2. 检查 Supabase 数据库
3. 提交 Issue 到 GitHub

---

**版本**：v2.0
**更新日期**：2026-02-04
**状态**：✅ 已完成
