# v4.0 任务编号系统 - 部署检查清单

## ⚠️ 重要提示

**必须按顺序执行以下步骤！**

---

## 第一步：数据库迁移（必须最先执行）

### 1.1 登录 Supabase 控制台
- 访问: https://supabase.com/dashboard
- 选择你的项目

### 1.2 执行迁移脚本
1. 点击左侧菜单 "SQL Editor"
2. 点击 "New query"
3. 打开本地文件 `database_update_v4.0.sql`
4. 复制全部内容
5. 粘贴到 SQL Editor
6. 点击 "Run" 执行

### 1.3 验证迁移结果
执行后应该看到类似输出：
```
NOTICE:  ✓ 所有任务已成功分配编号
NOTICE:  ✓ 所有任务编号连续无间隙
NOTICE:  ========================================
NOTICE:  v4.0 数据库迁移完成
NOTICE:  ========================================
NOTICE:  活跃任务数：X
NOTICE:  暂缓任务数：X
NOTICE:  用户数：X
NOTICE:  ========================================
```

### 1.4 检查新字段
在 SQL Editor 中执行：
```sql
SELECT 
    task_name, 
    task_order, 
    display_number, 
    is_deleted, 
    quadrant, 
    status 
FROM tasks 
WHERE user_email = '你的邮箱@163.com' 
  AND is_deleted = FALSE
ORDER BY quadrant, task_order;
```

应该看到：
- ✅ task_order 字段有值（1, 2, 3...）
- ✅ display_number 字段有值（Q1-1, Q1-2...）
- ✅ is_deleted 字段为 FALSE

---

## 第二步：验证核心函数

### 2.1 运行验证脚本
```bash
python scripts/test_v4_functions.py
```

### 2.2 预期输出
应该看到所有测试通过：
```
============================================================
v4.0 任务编号系统 - 快速验证
============================================================

测试用户: your_email@163.com
Supabase URL: https://xxx.supabase.co

============================================================
测试1: get_max_task_order()
============================================================
✅ Q1象限最大编号: X

============================================================
测试2: find_task()
============================================================
✅ 找到任务: XXX

... (其他测试)

============================================================
✅ 所有测试通过！v4.0 系统运行正常
============================================================

可以安全部署到生产环境。
```

---

## 第三步：代码部署（GitHub Actions）

### 3.1 提交代码到 GitHub
```bash
git add .
git commit -m "Deploy v4.0 task numbering system"
git push origin main
```

### 3.2 验证 GitHub Actions
1. 访问: https://github.com/你的用户名/ai-email-coach/actions
2. 确认以下 workflows 存在且启用：
   - ✅ 每日复盘提醒 (Daily Review)
   - ✅ 检查邮件回复 (Check Email Reply)
   - ✅ 每周暂缓任务提醒 (Weekly Paused Tasks)

---

## 第四步：功能测试

### 4.1 测试每日复盘邮件
**手动触发**:
1. 访问 GitHub Actions
2. 选择 "每日复盘提醒" workflow
3. 点击 "Run workflow"
4. 等待执行完成

**检查邮件内容**:
- ✅ 任务按象限分组显示（Q1-Q4）
- ✅ 每个任务显示编号（1, 2, 3...）
- ✅ 暂缓待办池单独显示
- ✅ 回复格式示例包含编号引用

### 4.2 测试邮件回复处理
**发送测试回复**:
回复每日复盘邮件，内容：
```
Q1任务1进度50%
```

**手动触发处理**:
1. 访问 GitHub Actions
2. 选择 "检查邮件回复" workflow
3. 点击 "Run workflow"
4. 等待执行完成

**检查反馈邮件**:
- ✅ 显示任务编号（Q1-1）
- ✅ 显示进度条
- ✅ 显示经验值奖励
- ✅ AI 个性化反馈

### 4.3 测试任务完成
**发送测试回复**:
```
Q1任务1完成
```

**检查结果**:
1. 手动触发 "检查邮件回复"
2. 检查反馈邮件：
   - ✅ 显示完成标记
   - ✅ 显示经验值奖励
3. 再次触发 "每日复盘提醒"
4. 检查邮件：
   - ✅ 已完成的任务不再出现
   - ✅ 其他任务编号自动重排（原Q1-2变成Q1-1）

### 4.4 测试暂缓任务
**发送测试回复**:
```
Q2任务1暂缓
```

**检查结果**:
1. 手动触发 "检查邮件回复"
2. 再次触发 "每日复盘提醒"
3. 检查邮件：
   - ✅ 任务从Q2象限消失
   - ✅ 出现在"暂缓待办池"
   - ✅ 显示暂缓任务编号

### 4.5 测试恢复暂缓任务
**发送测试回复**:
```
暂缓任务1恢复到Q1
```

**检查结果**:
1. 手动触发 "检查邮件回复"
2. 检查反馈邮件：
   - ✅ 显示新编号（Q1-X）
3. 再次触发 "每日复盘提醒"
4. 检查邮件：
   - ✅ 任务出现在Q1象限
   - ✅ 从暂缓待办池消失

---

## 第五步：生产环境监控

### 5.1 设置定时任务
确认 GitHub Actions 定时任务已启用：
- ✅ 每日复盘：每天 21:30 (UTC 13:30)
- ✅ 检查回复：每天 23:30 (UTC 15:30)
- ✅ 暂缓任务：每周日 20:00 (UTC 12:00)

### 5.2 监控日志
每天检查 GitHub Actions 执行日志：
- ✅ 无错误信息
- ✅ 邮件发送成功
- ✅ 数据库操作成功

---

## 常见问题排查

### Q0: 数据库迁移报错 "tasks_status_check" 约束冲突 ⭐ 最常见
**症状**: 
```
ERROR: 23514: new row for relation "tasks" violates check constraint "tasks_status_check"
```

**原因**: 数据库约束不允许 `status='paused'`

**解决**: 
1. 确认使用的是修复后的 `database_update_v4.0.sql`（已包含约束更新）
2. 如果仍然失败，参考 `v4.0_紧急修复说明.md` 手动分步执行
3. 或者先单独执行约束更新：
```sql
ALTER TABLE tasks DROP CONSTRAINT IF EXISTS tasks_status_check;
ALTER TABLE tasks ADD CONSTRAINT tasks_status_check 
    CHECK (status IN ('active', 'completed', 'paused', 'backlog'));
```
然后重新执行完整的迁移脚本。

### Q1: 数据库迁移失败
**症状**: SQL 执行报错
**解决**:
1. 检查是否有语法错误
2. 确认 Supabase 连接正常
3. 检查是否有权限问题

### Q2: 任务编号不连续
**症状**: 出现 Q1-1, Q1-3, Q1-5（缺少2和4）
**解决**:
```sql
-- 手动触发重排序
SELECT * FROM tasks 
WHERE user_email = '你的邮箱' 
  AND quadrant = 1 
  AND status = 'active' 
  AND is_deleted = FALSE
ORDER BY task_order;

-- 如果发现间隙，在 Python 中调用：
# reorder_tasks(supabase_url, headers, user_email, 1)
```

### Q3: 已完成任务仍然出现
**症状**: 标记完成的任务第二天还在
**检查**:
```sql
SELECT task_name, status, is_deleted, deleted_at
FROM tasks
WHERE user_email = '你的邮箱'
  AND task_name = '问题任务名';
```

**解决**:
- 如果 is_deleted = FALSE，说明完成操作失败
- 手动设置：
```sql
UPDATE tasks
SET is_deleted = TRUE, 
    deleted_at = NOW(), 
    status = 'completed'
WHERE id = '任务ID';
```

### Q4: 暂缓任务每天都提醒
**症状**: 暂缓任务应该2天提醒一次，但每天都收到
**检查**:
```sql
SELECT task_name, last_reminded_date
FROM tasks
WHERE user_email = '你的邮箱'
  AND status = 'paused';
```

**解决**:
- 如果 last_reminded_date 没有更新，检查 daily_review.py 中的更新逻辑
- 手动更新：
```sql
UPDATE tasks
SET last_reminded_date = CURRENT_DATE
WHERE user_email = '你的邮箱'
  AND status = 'paused';
```

---

## 回滚方案

如果 v4.0 出现严重问题，可以回滚到 v3.x：

### 回滚步骤
1. **代码回滚**:
```bash
git revert HEAD
git push origin main
```

2. **数据库回滚**（可选，如果需要恢复已删除的completed任务）:
```sql
-- v4.0 删除了所有 completed 任务
-- 如果有备份，可以从备份恢复
-- 否则，这些任务无法恢复（但不影响系统运行）
```

3. **验证回滚**:
- 检查每日复盘邮件格式恢复到 v3.x
- 检查任务显示不再有编号

---

## 部署完成确认

所有步骤完成后，确认以下检查项：

- [ ] 数据库迁移成功执行
- [ ] 验证脚本全部通过
- [ ] 代码已推送到 GitHub
- [ ] GitHub Actions 正常运行
- [ ] 每日复盘邮件显示任务编号
- [ ] 邮件回复处理支持编号引用
- [ ] 完成的任务不再重复出现
- [ ] 暂缓任务正常工作
- [ ] 定时任务按时执行

**全部确认后，v4.0 部署完成！🎉**

---

## 今晚使用建议

由于你希望今晚就使用最新版本，建议：

1. **立即执行数据库迁移**（5分钟）
2. **运行验证脚本**（2分钟）
3. **推送代码到 GitHub**（1分钟）
4. **手动触发一次每日复盘**（测试新格式）
5. **回复测试邮件**（测试编号引用）

总计约 10-15 分钟即可完成部署并开始使用。

**注意**: 可选的单元测试和属性测试（任务9-10）可以之后再补充，不影响今晚使用。
