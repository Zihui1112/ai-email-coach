# v3.3 商店系统部署指南

## 📋 更新内容

v3.3 版本实现了完整的商店系统：

### 🛒 核心功能
1. **购买命令识别**：识别"购买：道具名"命令
2. **资格检查**：等级、金币、购买限制检查
3. **自动扣款**：购买成功自动扣除金币
4. **背包管理**：道具自动添加到背包
5. **购买反馈**：成功/失败消息提示
6. **背包显示**：在邮件中显示拥有的道具

### 🎁 可购买道具（22种）

#### 基础道具（LV1+，惩罚相关）
1. **🛡️ 惩罚减免券**（50 Coin）- 免除一次未回复惩罚，每周限购2次
2. **🔥 连击保护卡**（100 Coin）- 保护连续回复记录不中断，每月限购1次
3. **🔒 进度锁定符**（80 Coin）- 锁定任务进度3天，每周限购1次
4. **🛡️ 降级保护盾**（200 Coin）- 防止降级一次（自动触发），每月限购1次

#### 基础道具（LV13+）
5. **🛡️ 拖延对冲券**（100 Coin）- 免除惩罚，任务顺延明天，每周限购1次
6. **🔄 象限置换权**（50 Coin）- Q1→Q4合法降级，每周限购1次
7. **⏰ 时间回溯卡**（80 Coin）- 撤销今天的任务更新，每周限购1次
8. **📝 任务分解器**（60 Coin）- AI帮你把大任务拆成小任务，无限购买
9. **🎯 专注加成卡**（70 Coin）- 当日Q1任务EXP x1.5，每周限购3次

#### 激励道具（LV13+）
10. **💬 AI夸夸盲盒**（30 Coin）- 500字小作文赞美，无限购买
11. **⚡ 经验加速卡**（80 Coin）- 当日所有EXP x2，每周限购2次
12. **💰 金币翻倍卡**（100 Coin）- 当日金币收入 x2，每周限购1次
13. **🎲 幸运骰子**（50 Coin）- 随机获得50-200币，每日限购1次

#### 高级道具（LV16+）
14. **🏆 月度勋章**（500 Coin）- 生成精美月报卡片，每月限购1次
15. **🎭 性格解锁卡**（300 Coin）- 永久解锁一个新性格，无限购买
16. **📊 数据透视镜**（200 Coin）- 查看详细的任务分析报告，每周限购1次
17. **🔮 未来预测**（150 Coin）- AI预测你下周的任务完成率，每周限购1次

#### 特殊道具（LV20）
18. **👑 VIP特权卡**（1000 Coin）- 7天内所有EXP和金币 x1.5，每月限购1次
19. **🌟 成就收割机**（800 Coin）- 立即完成所有连击成就，每月限购1次
20. **🎨 定制AI**（2000 Coin）- 自定义AI的说话风格，无限购买

---

## 🚀 部署步骤

### 第一步：无需数据库更新

v3.3 不需要数据库更新，因为：
- `shop_items` 表已经有所有道具数据（v3.0+v3.1创建）
- `user_inventory` 表已经创建（v3.0创建）

**✅ 跳过数据库更新步骤！**

---

### 第二步：推送代码到 GitHub

```bash
# 查看修改的文件
git status

# 添加所有修改
git add .

# 提交修改
git commit -m "v3.3: 实现商店系统"

# 推送到 GitHub
git push origin main
```

### 验证 GitHub Actions

1. 打开浏览器，访问你的 GitHub 仓库
2. 点击顶部的 **Actions** 标签
3. 查看是否有新的工作流正在运行
4. 等待所有工作流完成（绿色 ✅）

**✅ 代码部署完成！**

---

## 🧪 功能测试

### 测试1：查看商店提示（LV13+）

**测试场景**：LV13以上用户查看每日复盘邮件

1. [ ] 确认当前等级 >= LV13
2. [ ] 等待今晚22:00收到每日复盘邮件
3. [ ] 预期结果：
   ```
   🛒 商店已解锁！
   格式：购买：道具名
   示例：购买：拖延对冲券
   ```

### 测试2：成功购买道具

**测试场景**：购买惩罚减免券（50 Coin）

1. [ ] 确认金币 >= 50 Coin
2. [ ] 回复邮件：
   ```
   完成了测试任务50% Q1
   购买：惩罚减免券
   ```
3. [ ] 等待23:30收到反馈
4. [ ] 预期结果：
   ```
   ╔═══════════════════════════════════╗
   ║  🛒 购买成功                      ║
   ╠═══════════════════════════════════╣
   ║                                   ║
   ║  道具：🛡️ 惩罚减免券              ║
   ║  花费：-50 Coin                   ║
   ║  余额：150 Coin                   ║
   ║                                   ║
   ║  💡 道具已添加到你的背包          ║
   ║                                   ║
   ╚═══════════════════════════════════╝
   
   💼 背包：
      🛡️ 惩罚减免券 x1
   ```
5. [ ] 在 Supabase 中查看 `user_inventory` 表，确认道具已添加

### 测试3：金币不足

**测试场景**：金币不足时购买

1. [ ] 确认金币 < 100 Coin
2. [ ] 回复邮件：`购买：拖延对冲券`（100 Coin）
3. [ ] 预期结果：
   ```
   ⚠️ 购买失败：金币不足
   
   需要金币：100 Coin
   当前金币：50 Coin
   还差：50 Coin
   
   💡 完成更多任务获得金币！
   ```

### 测试4：等级不足

**测试场景**：LV1尝试购买LV13道具

1. [ ] 确认当前等级 < LV13
2. [ ] 回复邮件：`购买：拖延对冲券`
3. [ ] 预期结果：
   ```
   ⚠️ 购买失败：等级不足
   
   需要等级：LV13
   当前等级：LV1
   
   💡 继续升级即可解锁！
   ```

### 测试5：购买限制

**测试场景**：超过每周限购次数

1. [ ] 购买惩罚减免券2次（每周限购2次）
2. [ ] 尝试第3次购买
3. [ ] 预期结果：
   ```
   ⚠️ 购买失败：已达到购买限制
   
   每周限购：2次
   
   💡 请等待限制重置后再购买
   ```

### 测试6：道具名称模糊匹配

**测试场景**：不输入完整道具名

1. [ ] 回复邮件：`购买：惩罚减免`（不带"券"）
2. [ ] 预期结果：成功购买惩罚减免券
3. [ ] 也可以尝试：`购买：减免券`

### 测试7：背包显示

**测试场景**：查看背包中的道具

1. [ ] 购买几个道具
2. [ ] 查看每日复盘邮件或任务更新反馈
3. [ ] 预期结果：
   ```
   💼 背包：
      🛡️ 惩罚减免券 x2
      🔥 连击保护卡 x1
      🔒 进度锁定符 x1
   ```

---

## 📝 购买命令格式

支持以下格式（都有效）：

```
购买：惩罚减免券
购买：拖延对冲券
购买：AI夸夸盲盒

买：惩罚减免券
买：拖延对冲券

兑换：惩罚减免券
兑换：拖延对冲券

# 也可以不输入完整名称（模糊匹配）
购买：惩罚减免
购买：拖延对冲
购买：夸夸盲盒
```

---

## 🎯 道具分类和价格

### 惩罚相关（LV1+）
| 道具 | 价格 | 限制 | 效果 |
|------|------|------|------|
| 🛡️ 惩罚减免券 | 50 | 每周2次 | 免除一次未回复惩罚 |
| 🔥 连击保护卡 | 100 | 每月1次 | 保护连续回复记录 |
| 🔒 进度锁定符 | 80 | 每周1次 | 锁定任务进度3天 |
| 🛡️ 降级保护盾 | 200 | 每月1次 | 防止降级一次 |

### 基础道具（LV13+）
| 道具 | 价格 | 限制 | 效果 |
|------|------|------|------|
| 🛡️ 拖延对冲券 | 100 | 每周1次 | 任务顺延明天 |
| 🔄 象限置换权 | 50 | 每周1次 | Q1→Q4降级 |
| ⏰ 时间回溯卡 | 80 | 每周1次 | 撤销今天更新 |
| 📝 任务分解器 | 60 | 无限 | AI拆分任务 |
| 🎯 专注加成卡 | 70 | 每周3次 | Q1任务EXP x1.5 |

### 激励道具（LV13+）
| 道具 | 价格 | 限制 | 效果 |
|------|------|------|------|
| 💬 AI夸夸盲盒 | 30 | 无限 | 500字赞美 |
| ⚡ 经验加速卡 | 80 | 每周2次 | 所有EXP x2 |
| 💰 金币翻倍卡 | 100 | 每周1次 | 金币收入 x2 |
| 🎲 幸运骰子 | 50 | 每日1次 | 随机50-200币 |

### 高级道具（LV16+）
| 道具 | 价格 | 限制 | 效果 |
|------|------|------|------|
| 🏆 月度勋章 | 500 | 每月1次 | 月报卡片 |
| 🎭 性格解锁卡 | 300 | 无限 | 解锁新性格 |
| 📊 数据透视镜 | 200 | 每周1次 | 任务分析报告 |
| 🔮 未来预测 | 150 | 每周1次 | 预测完成率 |

### 特殊道具（LV20）
| 道具 | 价格 | 限制 | 效果 |
|------|------|------|------|
| 👑 VIP特权卡 | 1000 | 每月1次 | 7天EXP/金币 x1.5 |
| 🌟 成就收割机 | 800 | 每月1次 | 完成所有连击成就 |
| 🎨 定制AI | 2000 | 无限 | 自定义AI风格 |

---

## 🐛 问题排查

### 问题1：购买命令不识别
- [ ] 确认命令格式正确（参考上面的格式）
- [ ] 确认命令在邮件正文中（不是标题）
- [ ] 查看 Actions 日志，搜索 "购买"

### 问题2：道具不存在
- [ ] 检查道具名称是否正确
- [ ] 尝试使用模糊匹配（不输入完整名称）
- [ ] 在 Supabase 中查看 `shop_items` 表确认道具列表

### 问题3：购买失败但原因不明
- [ ] 查看 Actions 日志中的详细错误
- [ ] 在 Supabase 中查看 `user_gamification` 表的金币余额
- [ ] 在 Supabase 中查看 `user_inventory` 表的购买记录

### 问题4：背包不显示
- [ ] 确认已经购买过道具
- [ ] 在 Supabase 中查看 `user_inventory` 表
- [ ] 确认 `quantity` 字段 > 0

---

## 📊 数据查看

### 查看用户背包
1. 登录 Supabase
2. 点击 **Table Editor**
3. 点击 `user_inventory` 表
4. 查看用户的道具：
   - `item_code`: 道具代码
   - `quantity`: 数量
   - `usage_count_daily/weekly/monthly`: 使用次数

### 查看商店道具
1. 点击 `shop_items` 表
2. 查看所有可购买的道具
3. 字段说明：
   - `item_name`: 道具名称
   - `price`: 价格
   - `required_level`: 需要等级
   - `usage_limit_type`: 限制类型
   - `usage_limit_count`: 限制次数

---

## ✅ 部署完成确认

当以下所有项都打勾时，说明 v3.3 部署成功：

- [ ] 代码推送到 GitHub 成功
- [ ] GitHub Actions 运行成功
- [ ] LV13+用户看到商店提示
- [ ] 成功购买道具
- [ ] 金币正确扣除
- [ ] 道具添加到背包
- [ ] 背包正确显示
- [ ] 购买限制正常工作

**🎉 恭喜！v3.3 商店系统部署成功！**

---

## 💡 使用建议

### 对用户的建议
1. **优先购买惩罚相关道具**：避免惩罚损失
2. **合理规划金币**：不要一次花光
3. **注意购买限制**：每周/每月限购道具要谨慎使用
4. **LV13前积累金币**：解锁商店后可以大量购买

### 购买策略
- **新手期（LV1-12）**：购买惩罚减免券、连击保护卡
- **进阶期（LV13-15）**：购买经验加速卡、金币翻倍卡
- **高级期（LV16-19）**：购买月度勋章、数据透视镜
- **大师期（LV20）**：购买VIP特权卡、定制AI

### 金币管理
- **保底金币**：至少保留100 Coin应急
- **定期购买**：不要囤积太多金币
- **优先级**：惩罚相关 > 经验加速 > 其他

---

## 🔮 道具使用（待实现）

目前道具购买后会添加到背包，但使用逻辑还未实现。

下一版本（v3.4）将实现：
1. 道具使用命令识别（"使用：道具名"）
2. 道具效果触发
3. 使用次数限制检查
4. 道具消耗和背包更新

---

**版本**：v3.3  
**更新日期**：2026-02-10  
**状态**：商店系统已完成，等待测试  
**下一步**：测试通过后实现道具使用逻辑
