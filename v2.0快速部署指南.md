# v2.0 快速部署指南

## ✅ 已完成的修改

### 1. 暂缓任务管理
- ✅ 暂缓任务保存在数据库（status='paused'）
- ✅ 每周日21:00自动检查暂缓任务
- ✅ 显示暂缓天数

### 2. AI个性化反馈
- ✅ 根据进度变化生成不同反馈
- ✅ 根据任务数量给出建议
- ✅ 语气温暖友好

### 3. 连续未回复提醒
- ✅ 追踪最后回复时间
- ✅ 计算连续未回复天数
- ✅ 根据天数调整提醒强度

## 🚀 部署步骤（3步）

### 步骤1：更新数据库（必须）

1. 登录 Supabase：https://supabase.com
2. 进入你的项目
3. 点击左侧 "SQL Editor"
4. 点击 "New query"
5. 复制 `database_update_v2.sql` 的内容
6. 粘贴并点击 "Run"
7. 看到 "Success" 表示成功

### 步骤2：推送代码到 GitHub

```bash
git push
```

如果遇到网络问题，多试几次。

### 步骤3：验证部署

访问：https://github.com/Zihui1112/ai-email-coach/actions

应该能看到新的 workflow：
- ✅ 每日复盘提醒
- ✅ 每日跟进提醒
- ✅ 检查邮件回复
- ✅ 每周暂缓任务检查 ⭐新增
- ✅ 周报
- ✅ 月报

## 🧪 测试新功能

### 测试1：暂缓任务

1. 手动触发「每日复盘提醒」
2. 回复邮件：「暂缓XX任务」
3. 等待23:30自动检查
4. 查看 Supabase tasks 表，status 应该是 'paused'
5. 手动触发「每周暂缓任务检查」
6. 应该收到暂缓任务列表

### 测试2：AI个性化反馈

1. 手动触发「每日复盘提醒」
2. 回复邮件更新任务进度
3. 等待23:30自动检查
4. 应该收到AI生成的个性化反馈（不是"继续加油"）

### 测试3：连续未回复提醒

1. 今天不回复邮件
2. 明天22:00会收到提醒：「昨天好像没看到你的回复」
3. 继续不回复
4. 后天22:00会收到更强烈的提醒

## 📊 数据库检查

### 检查新表是否创建成功

在 Supabase SQL Editor 中执行：

```sql
-- 检查 user_reply_tracking 表
SELECT * FROM user_reply_tracking;

-- 检查 task_progress_snapshot 表
SELECT * FROM task_progress_snapshot;

-- 检查 tasks 表的 paused 状态
SELECT * FROM tasks WHERE status = 'paused';
```

### 检查约束是否更新

```sql
-- 检查 tasks 表的 status 约束
SELECT conname, pg_get_constraintdef(oid) 
FROM pg_constraint 
WHERE conrelid = 'tasks'::regclass 
AND conname = 'tasks_status_check';
```

应该看到包含 'paused' 的约束。

## ⚠️ 常见问题

### Q1: 数据库更新失败

**错误**：`constraint "tasks_status_check" already exists`

**解决**：
```sql
-- 先删除旧约束
ALTER TABLE tasks DROP CONSTRAINT IF EXISTS tasks_status_check;

-- 再添加新约束
ALTER TABLE tasks ADD CONSTRAINT tasks_status_check 
    CHECK (status IN ('active', 'completed', 'paused', 'backlog'));
```

### Q2: AI反馈不工作

**可能原因**：
1. DeepSeek API key 无效
2. API 调用超时
3. 网络问题

**解决**：
- 检查 GitHub Secrets 中的 DEEPSEEK_API_KEY
- 查看 GitHub Actions 日志
- 如果 API 失败，会使用默认反馈

### Q3: 暂缓任务不显示

**可能原因**：
1. 数据库未更新
2. 任务 status 不是 'paused'

**解决**：
```sql
-- 检查任务状态
SELECT task_name, status FROM tasks WHERE user_email = '你的邮箱';

-- 手动设置为 paused
UPDATE tasks SET status = 'paused' WHERE task_name = '任务名称';
```

### Q4: 连续未回复天数不准确

**原因**：首次部署时，last_reply_date 为 NULL

**解决**：等待一天后会自动准确

或手动设置：
```sql
UPDATE user_reply_tracking 
SET last_reply_date = CURRENT_DATE 
WHERE user_email = '你的邮箱';
```

## 📝 使用示例

### 暂缓任务

**你的回复**：
```
完成了用户登录90%
暂缓API开发
```

**系统反应**：
- 用户登录：status=active, progress=90
- API开发：status=paused
- 周日会询问是否重新开始

### 重新开始暂缓任务

**周日收到提醒后回复**：
```
重新开始API开发
```

**系统反应**：
- API开发：status=active
- 重新出现在每日任务清单

### AI个性化反馈示例

**场景1：进度提升大**
> 哇，用户登录功能从60%提升到90%，进展真快！看来你最近状态不错。

**场景2：任务多**
> 看到你手上有5个任务，要注意合理分配时间哦。建议优先完成Q1象限的任务。

**场景3：暂缓任务**
> 理解你暂缓了API开发，有时候确实需要调整优先级。专注在当前的任务上就好。

## 🎯 验证清单

部署完成后，检查以下项目：

- [ ] 数据库更新成功（3个新表/约束）
- [ ] 代码推送到 GitHub
- [ ] GitHub Actions 显示新的 workflow
- [ ] 手动触发测试成功
- [ ] 暂缓任务功能正常
- [ ] AI反馈生成正常
- [ ] 连续未回复提醒正常

## 📞 需要帮助？

1. 查看 `v2.0更新说明.md` 了解详细信息
2. 查看 GitHub Actions 日志
3. 检查 Supabase 数据库
4. 查看错误信息并搜索解决方案

---

**版本**：v2.0
**部署时间**：约5分钟
**难度**：⭐⭐（简单）
